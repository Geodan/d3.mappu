/*! d3.mappu VERSION: 0.0.1 18-02-2016 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){c.POINT=1,c.LINESTRING=2,c.POLYGON=3,c.MULTIPOINT=4,c.MULTILINESTRING=5,c.MULTIPOLYGON=6,c.COLLECTION=7},{}],2:[function(a,b,c){function d(a){for(var b,c=a.cursor,d=0,e=0;;){if(b=a.buffer[c],0===(128&b))return c++,a.cursor=c,d|b<<e;d|=(127&b)<<e,c++,e+=7}}function e(a){var b=d(a);return f(b)}function f(a){return 0===(1&a)?a>>1:-(a>>1)-1}c.ReadVarInt64=d,c.ReadVarSInt64=e,c.unzigzag=f},{}],3:[function(a,b){function c(a,b,c){c=c||Number.MAX_VALUE;for(var e={buffer:a,cursor:void 0===b?0:b,bufferLength:a.byteLength||a.length,refpoint:new Int32Array(4)},f=[],g=0;e.cursor<e.bufferLength&&c>g;){var h=d(e,c);h.length>0?f.push({type:e.type,offset:c<Number.MAX_VALUE?e.cursor:void 0,bbox:e.has_bbox?e.bbox:void 0,coordinates:h}):(h.bbox=e.has_bbox?e.bbox:void 0,f.push(h)),g++}return f}var d=a("./readBuffer");b.exports=c},{"./readBuffer":4}],4:[function(a,b){function c(a,b){var c,e=0,f=0;c=a.buffer[a.cursor],a.cursor++;var g=o((240&c)>>4);a.type=15&c,a.factors=[],a.factors[0]=a.factors[1]=Math.pow(10,g),c=a.buffer[a.cursor],a.cursor++,a.has_bbox=1&c,a.has_size=(2&c)>>1,a.has_idlist=(4&c)>>2,a.is_empty=(16&c)>>4;var h=(8&c)>>3;if(h){var i=a.buffer[a.cursor];a.cursor++,e=1&i,f=(2&i)>>1;var j=(28&i)>>2,k=(224&i)>>5;e&&(a.factors[2]=Math.pow(10,j)),f&&(a.factors[2+e]=Math.pow(10,k)),a.has_z=e,a.has_m=f}var l=2+e+f;if(a.ndims=l,a.has_size&&(a.size=m(a)),a.has_bbox){for(var p=[],q=0;l-1>=q;q++){var r=n(a),s=r+n(a);p[q]=r,p[q+l]=s}a.bbox=p}return d(a,b)}function d(a,b){for(var c=a.type,d=0;d<a.ndims;d++)a.refpoint[d]=0;if(c===l.POINT)return e(a);if(c===l.LINESTRING)return f(a);if(c===l.POLYGON)return g(a);if(c===l.MULTIPOINT)return h(a,e);if(c===l.MULTILINESTRING)return h(a,f);if(c===l.MULTIPOLYGON)return h(a,g);if(c===l.COLLECTION)return i(a,b);throw new Error("Unknown type: "+c)}function e(a){return j(a,1)}function f(a){const b=m(a);return j(a,b)}function g(a){for(var b=[],c=m(a),d=0;c>d;++d)b[d]=f(a);return b}function h(a,b){var c=a.type,d=m(a),e=[],f=[];a.has_idlist&&(f=k(a,d));for(var g=0;d>g;g++){var h=b(a);e.push(h)}return{type:c,ids:f,geoms:e}}function i(a,b){var d=a.type,e=m(a),f=[],g=[];a.has_idlist&&(g=k(a,e));for(var h=0;e>h&&b>h;h++){var i=c(a);f.push({type:a.type,coordinates:i})}return{type:d,ids:g,ndims:a.ndims,offset:b<Number.MAX_VALUE?a.cursor:void 0,geoms:f}}function j(a,b){var c,d,e=a.ndims,f=a.factors,g=new Array(b*e);for(c=0;b>c;c++)for(d=0;e>d;d++)a.refpoint[d]+=n(a),g[e*c+d]=a.refpoint[d]/f[d];if(a.include_bbox&&!a.has_bbox)for(c=0;b>c;c++)for(d=0;e>d;d++){const h=g[d*e+c];h<a.bbox.min[d]&&(a.bbox.min[d]=h),h>a.bbox.max[d]&&(a.bbox.max[d]=h)}return g}function k(a,b){const c=[];for(var d=0;b>d;d++)c.push(n(a));return c}var l=a("./constants"),m=a("./protobuf").ReadVarInt64,n=a("./protobuf").ReadVarSInt64,o=a("./protobuf").unzigzag;b.exports=c},{"./constants":1,"./protobuf":2}],5:[function(a,b){function c(a,b){return{type:k[a],coordinates:b}}function d(a,b,c,d){return{type:"Feature",id:c,geometry:l[a](b,d)}}function e(a,b,c,e){return b.map(function(b,f){return d(a,b,c?c[f]:void 0,e)})}function f(a,b,c){return a.map(function(a,e){return d(a.type,a.coordinates,b?b[e]:void 0,c)})}function g(a,b){for(var c=[],d=0,e=a.length;e>d;d+=b){for(var f=[],g=0;b>g;++g)f.push(a[d+g]);c.push(f)}return c}function h(a){for(var b={buffer:a,cursor:0,bufferLength:a.byteLength||a.length,refpoint:new Int32Array(4)},c=[];b.cursor<b.bufferLength;){var d=j(b,Number.MAX_VALUE);d.geoms?c=c.concat(l[d.type](d.geoms,d.ids,b.ndims)):c.push({type:"Feature",geometry:l[b.type](d,b.ndims)})}return{type:"FeatureCollection",features:c}}var i=a("./constants"),j=a("./readBuffer"),k={};k[i.POINT]="Point",k[i.LINESTRING]="LineString",k[i.POLYGON]="Polygon";var l={};l[i.POINT]=function(a,b){return c(i.POINT,g(a,b)[0])},l[i.LINESTRING]=function(a,b){return c(i.LINESTRING,g(a,b))},l[i.POLYGON]=function(a,b){return c(i.POLYGON,a.map(function(a){return g(a,b)}))},l[i.MULTIPOINT]=function(a,b,c){return e(i.POINT,a,b,c)},l[i.MULTILINESTRING]=function(a,b,c){return e(i.LINESTRING,a,b,c)},l[i.MULTIPOLYGON]=function(a,b,c){return e(i.POLYGON,a,b,c)},l[i.COLLECTION]=function(a,b,c){return f(a,b,c)},b.exports=h},{"./constants":1,"./readBuffer":4}],6:[function(a,b){(function(c){var d=a("./constants"),e=a("./toGeoJSON"),f=a("./read"),g={toGeoJSON:e,read:f};for(var h in d)g[h]=d[h];b.exports=g,c.twkb=g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./constants":1,"./read":3,"./toGeoJSON":5}]},{},[6]),d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ãƒƒ-"+_ctr;return _ctr++,a},d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){function c(a,b){var c=1<<a;t.scale(c),k.scale(t.scale()/2/Math.PI).translate(t.translate());var d=k(b),e=t.translate(),f=[e[0]+(g-d[0])-g/2,e[1]+(h-d[1])-h/2];t.translate(f)}var d,e={},f=[];d="object"==typeof a?a:document.getElementById(a),window.onresize=function(){r()};var g=d.clientWidth||2024,h=d.clientHeight||window.innerHeight||768,i=[[0,0],[1,1]],j=b.center||[0,0],k=b.projection||d3.geo.mercator(),l=b.zoom||22,m=b.maxZoom||24,n=b.minZoom||15,o=b.maxView||[[-180,90],[180,-90]],p=d3.dispatch("loaded","zoomend"),q=function(){k.scale(t.scale()/2/Math.PI).translate(t.translate()),l=Math.log(t.scale())/Math.log(2);var a=[g/2,h/2];j=k.invert(a),v=u.scale(t.scale()).translate(t.translate())(),f.forEach(function(a){a.refresh(0)});var b=k.invert([0,d.clientHeight]),c=k.invert([d.clientWidth,0]);e.extent=[b,c],p.zoomend()},r=function(){g=d.clientWidth,h=d.clientHeight,d3.select(d).selectAll(".drawboard").attr("width",g).attr("height",h),u.size([g,h]),q()};k.scale((1<<l||4096)/2/Math.PI).translate([g/2,h/2]);var s=k(j),t=d3.behavior.zoom().scale(2*k.scale()*Math.PI).scaleExtent([1<<n,1<<m]).translate([g-s[0],h-s[1]]).on("zoom",q);d3.select(d).call(t);var u=d3.geo.tile().size([g,h]),v=u.scale(t.scale()).translate(t.translate())();c(l,j),r(),Object.defineProperty(e,"mapdiv",{get:function(){return d},set:function(){console.log("do not touch the mapdiv")}}),Object.defineProperty(e,"canvasdiv",{get:function(){return _canvasdiv},set:function(){console.log("do not touch the canvasdiv")}}),Object.defineProperty(e,"center",{get:function(){return j},set:function(a){c(l,a)}}),Object.defineProperty(e,"zoom",{get:function(){return l},set:function(a){m>=a&&a>=n?c(a,j):console.log("Zoomlevel exceeded",a,"Min:",n,"Max:",m)}}),Object.defineProperty(e,"minZoom",{get:function(){return n},set:function(a){n=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxZoom",{get:function(){return m},set:function(a){m=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxView",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(e,"projection",{get:function(){return k},set:function(a){k=a}}),Object.defineProperty(e,"extent",{get:function(){return i},set:function(a){i=a}}),Object.defineProperty(e,"tiles",{get:function(){return v},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(e,"zoombehaviour",{get:function(){return t},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(e,"layers",{get:function(){return f},set:function(){console.warn("No setting allowed for layers")}});var w=function(){console.warn("Not implemented yet")},x=function(a){var b=[];b[0]=k([a[0],a[1]]),b[1]=k([a[2],a[3]]);{var d=b[1][0]-b[0][0],e=b[1][1]-b[0][1];(b[0][0]+b[1][0])/2,(b[0][1]+b[1][1])/2,.9/Math.max(d/g,e/h)}l=22,j=[a[0]+(a[2]-a[0])/2,a[1]+(a[3]-a[1])/2],c(l,j)},y=function(a){if(!a.id)return console.warn("Not a valid layer. (No ID)"),!1;var b=f.indexOf(a);return b>-1&&f.splice(b,1),f.push(a),a._onAdd(e),e},z=function(a){var b=f.indexOf(a);return b>-1&&f.splice(b,1),A(),a._onRemove(e),e},A=function(){var a=d3.select(d).selectAll(".drawboard").data(f,function(a){return a.id});a.enter().append("svg").attr("id",function(a){return a.id}).style("position","absolute").classed("drawboard",!0).each(function(a){a.drawboard=d3.select(this)}).append("g"),a.exit().remove(),a.sort(function(a,b){return a.zindex-b.zindex})};return e.zoomToFeature=w,e.zoomToExtent=x,e.addLayer=y,e.removeLayer=z,e.orderLayers=A,e.redraw=q,e.resize=r,e.dispatch=p,e},d3.mappu=d3.mappu||{},d3.mappu.Sketch=function(a,b){return d3_mappu_Sketch(a,b)},d3_mappu_Sketch=function(){function a(){n.selectAll(".sketch").remove(),n.append("path").attr("d",function(){return o(s)}).classed("sketch",!0).style("stroke","blue").style("fill",function(){return"LineString"==r?"none":"blue"}).style("fill-opacity",.4)}function b(){var b=d3.mouse(this);q.push(m.projection.invert(b)),s.geometry.type="LineString",s.geometry.coordinates=q,a()}function c(){var b=d3.mouse(this);q=p.invert(b),s.id=(new Date).getTime().toString(),s.geometry.coordinates=q,a(),v()}function d(){q.pop(),q.pop(),s.geometry.type="LineString",s.geometry.coordinates=q,s.id=(new Date).getTime().toString(),a(),v()}function e(){s.geometry.type="Polygon",q.pop(),q.pop(),q.push(q[0]),s.geometry.coordinates=[q],s.id=(new Date).getTime().toString(),a(),v()}function f(){var b=s.geometry.coordinates.length,c=d3.mouse(this),d=m.projection.invert(c);b>=1&&(1==b?q[b]=d:q[b-1]=d,s.geometry.coordinates=q,a())}function g(){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0)}function h(a){var b=d3.mouse(m.mapdiv);d3.select(this).attr("cx",b[0]).attr("cy",b[1]),"Polygon"==r?d3.select(this).classed("sketchPointInter")?(d3.select(this).classed("sketchPointInter",!1).classed("sketchPoint",!0),a.index+1==s.geometry.coordinates[0].length?s.geometry.coordinates[0].splice(1,0,a):s.geometry.coordinates[0].splice(a.index+1,0,a)):(s.geometry.coordinates[0][a.index]=p.invert(b),0===a.index&&(s.geometry.coordinates[0].pop(),s.geometry.coordinates[0].push(p.invert(b))),a.index+1==s.geometry.coordinates[0].length&&(s.geometry.coordinates[0][0]=p.invert(b))):"LineString"==r?d3.select(this).classed("sketchPointInter")?(d3.select(this).classed("sketchPointInter",!1).classed("sketchPoint",!0),s.geometry.coordinates.splice(a.index+1,0,a)):s.geometry.coordinates[a.index]=p.invert(b):"Point"==r&&(s.geometry.coordinates=p.invert(b)),j()}function i(){d3.select(this).classed("dragging",!1),j()}function j(){if(n.selectAll(".sketch").remove(),n.append("path").attr("d",function(){return o(s)}).classed("sketch",!0).style("stroke","red").style("fill",function(){return"LineString"==r?"none":"red"}).style("fill-opacity",.4),"Point"==r)var a=[s.geometry.coordinates],b=[];else{switch(r){case"Polygon":var a=s.geometry.coordinates[0];break;case"LineString":var a=s.geometry.coordinates;break;default:console.warn(r," not supported")}a.forEach(function(a,b){a.index=b,a.fid=a.id});var b=a.map(function(b,c){if(c+1<a.length){var d=[];return d[0]=(b[0]+a[c+1][0])/2,d[1]=(b[1]+a[c+1][1])/2,d.index=b.index,d}});b.pop()}n.selectAll(".sketchPointInter").remove(),n.selectAll(".sketchPointInter").data(b).enter().append("circle").classed("sketchPointInter",!0).attr("cx",function(a){return p(a)[0]}).attr("cy",function(a){return p(a)[1]}).attr("r",10).style("stroke","steelBlue").style("fill","steelBlue").style("opacity",.5).call(w),n.selectAll(".sketchPoint").remove(),n.selectAll(".sketchPoint").data(a).enter().append("circle").classed("sketchPoint",!0).attr("cx",function(a){return p(a)[0]}).attr("cy",function(a){return p(a)[1]}).attr("r",10).style("stroke","steelBlue").style("fill","steelBlue").style("fillOpacity",.5).call(w)}function k(a){return m=a,m.sketch=l,n=d3.select(m.mapdiv).append("svg").attr("id","sketch").style("position","absolute").attr("width",m.mapdiv.clientWidth).attr("height",m.mapdiv.clientHeight).append("g"),p=m.projection,o=d3.geo.path().projection(m.projection).pointRadius(4.5),l}var l={},m=null,n=null,o=null,p=null,q=[],r=null,s=null,t=0,u=function(a){return new Promise(function(g){this.resolve=g,s={id:null,type:"Feature",geometry:{type:a,coordinates:[]},style:{opacity:.7},properties:{}},r=a,"Point"==r?d3.select(m.mapdiv).on("click",c):"LineString"==r?(s.style.fill="none",s.style.stroke="blue",s.style["stroke-width"]="4",s.style["stroke-linecap"]="round",d3.select(m.mapdiv).on("mousedown",b),d3.select(m.mapdiv).on("mousemove",f),d3.select(m.mapdiv).on("mousedown.doublemousedown",function(a){t++,t>1&&d(a),window.setTimeout(function(){t=0},300)})):"Polygon"==r&&(s.style.fill="blue",s.style.stroke="blue",d3.select(m.mapdiv).on("mousedown",b),d3.select(m.mapdiv).on("mousemove",f),d3.select(m.mapdiv).on("mousedown.doublemousedown",function(a){t++,t>1&&e(a),window.setTimeout(function(){t=0},300)}),d3.select(m.mapdiv).on("touchstart",function(){pressTimer=window.setTimeout(function(){e()},500)}).on("touchmove",function(a,b){console.log(a,b)}).on("touchend",function(){clearTimeout(pressTimer)}))})},v=function(){self.resolve(s),C()},w=d3.behavior.drag().origin(function(a){return a}).on("dragstart",g).on("drag",h).on("dragend",i),x=function(a){return new Promise(function(b){self.resolve=b,event.stopPropagation(),d3.select(m.mapdiv).on("click",function(){j(),z()}),s=a,r=a.geometry.type,j()})},y=function(){},z=function(){self.resolve(s),C()},A=function(a){return new Promise(function(b){b(a),C()})},B=function(){},C=function(){n.selectAll(".sketch").remove(),n.selectAll(".sketchPoint").remove(),n.selectAll(".sketchPointInter").remove(),s=null,q=[],d3.select(m.mapdiv).on("mousemove",null),d3.select(m.mapdiv).on("click",null),d3.select(m.mapdiv).on("mousedown",null),d3.select(m.mapdiv).on("doublemousedown",null),d3.select(m.mapdiv).on("touchstart",null),d3.select(m.mapdiv).on("touchend",null)};return l.draw=u,l.startEdit=y,l.startRemove=B,l.remove=A,l.finish=C,l.edit=x,l.addTo=k,l},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a,b){b=b||{};var c,d={},e=d3.mappu.util.createID(),f=a,g=1;g=b.opacity||1;var h=!0;("boolean"==typeof b.visible||"true"==b.visible||"false"==b.visible)&&(h=b.visible);var i=0,j=function(){},k=function(){},l=function(){},m=function(a){d.zindex=a},n=function(a){return a.addLayer(d),d};return Object.defineProperty(d,"id",{get:function(){return e},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(d,"name",{get:function(){return f},set:function(a){f=a}}),Object.defineProperty(d,"map",{get:function(){return c},set:function(a){c=a}}),Object.defineProperty(d,"opacity",{get:function(){return g},set:function(a){g=a,d.refresh(0)}}),Object.defineProperty(d,"visible",{get:function(){return h},set:function(a){h=a,d.draw(!0),d.refresh(0)}}),Object.defineProperty(d,"zindex",{get:function(){return i},set:function(a){i=a,d.map&&d.map.orderLayers()}}),d.refresh=j,d.moveUp=k,d.moveDown=l,d.addTo=n,d.setZIndex=m,d._instantiate=function(a){d.drawboard=d3.select(a).append("svg").attr("id",function(a){return a.id}).style("position","absolute").classed("drawboard",!0),d.drawboard.append("g")},d._onAdd=function(a){c=a,a.orderLayers(),d.draw();var b=new CustomEvent("layeradded",{detail:d});d.map.mapdiv.dispatchEvent(b)},d._onRemove=function(){var a=new CustomEvent("layerremoved");d.map.mapdiv.dispatchEvent(a)},d},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){function c(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function d(a){var b=d3.select(this);if(k)for(var c in k)b.select("path").style(c,k[c]);if(a.style)for(var c in a.style)b.select("path").style(c,a.style[c]);a._selected?b.append("path").attr("d",h).style("stroke","none").style("fill","red").classed("halo",!0):b.selectAll(".halo").remove()}function e(b){var d=i;if("Point"==b.geometry.type&&b.style&&b.style["marker-url"]){d(b.geometry.coordinates)[0],d(b.geometry.coordinates)[1],d3.select(this).append("g").append("image").attr("width",32).attr("height",37).attr("xlink:href",function(a){return a.style["marker-url"]})}else"Polygon"!=b.geometry.type||c(b.geometry.coordinates[0])||b.geometry.coordinates[0].reverse(),d3.select(this).append("path").attr("d",h).classed(a,!0);d3.select(this).append("text").classed("shadowtext",!0).attr("text-anchor","middle"),d3.select(this).append("text").classed("vectorLabel",!0).attr("text-anchor","middle")}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vector";var g=[];f.zindex=100;var h,i,j=b.duration||0,k=b.style||{},l=b.labelStyle||{},m=b.events;Object.defineProperty(f,"data",{get:function(){return g},set:function(a){g=a,n(!1)}}),Object.defineProperty(f,"events",{get:function(){return m},set:function(a){m=a}});var n=function(a){b.reproject?(i=f.map.projection,h=d3.geo.path().projection(i).pointRadius(function(a){return a.style&&a.style.radius?a.style.radius:4.5})):(i=d3.geo.mercator().scale(.5/Math.PI).translate([0,0]),h=d3.geo.path().projection(i));var c=f.drawboard;a&&c.selectAll(".entity").remove();var k=c.select("g").selectAll(".entity").data(g,function(a){return a.id}),l=k.enter().append("g").classed("entity",!0).attr("id",function(a){return"entity"+a.id});l.each(e),l.each(d),k.exit().remove(),m&&m.forEach(function(a){k.each(function(){d3.select(this).select("path").on(a.event,a.action),d3.select(this).select("image").on(a.event,a.action)})}),f.refresh(a?0:j)},o=d3.scale.linear().range([20,20,32,32]).domain([0,21,24,30]),p=d3.scale.linear().range([20,20,37,37]).domain([0,21,24,30]),q=function(a){var c=f.drawboard;if(c.select("g").style("opacity",this.opacity).style("display",this.visible?"block":"none"),f.visible){var e=c.select("g").selectAll(".entity");if(b.reproject){var g=f.map.projection;e.select("path").transition().duration(a).attr("d",h),e.select("image").transition().duration(a).each(function(a){var b=o(f.map.zoom),c=p(f.map.zoom),d=g(a.geometry.coordinates)[0],e=g(a.geometry.coordinates)[1],h=b/2,i=c/2;d3.select(this).attr("x",d).attr("y",e).attr("width",b).attr("height",c),a.style&&a.style.rotate?d3.select(this.parentElement).attr("transform","translate("+-h+" "+-i+") rotate("+a.style.rotate+" "+Math.round(d+h)+"  "+Math.round(e+i)+")"):d3.select(this.parentElement).attr("transform","translate("+-h+" "+-i+")")}),b.labelfield&&(f.map.zoom<22?e.selectAll("text").text(""):e.each(function(a){var c=h.centroid(a),d=a.properties[b.labelfield];d3.select(this).selectAll("text").attr("x",c[0]).attr("y",c[1]-20).text(d);for(var e in l)d3.select(this).selectAll("text").style(e,l[e]);d3.select(this).select(".shadowtext").style("stroke-width","2.5px").style("stroke","white").style("opacity",.8)})),e.each(d)}else{var i=f.map.zoombehaviour;c.select("g").attr("transform","translate("+i.translate()+")scale("+i.scale()+")").style("stroke-width",1/i.scale())}}else c.selectAll(".entity").remove()},r=function(a){var b=d3.map(g,function(a){return a.id});b.set(a.id,a),g=b.values(),f.draw(!0)},s=function(a){var b=null;g.forEach(function(c,d){c.id==a.id&&(b=d)}),g.splice(b,1),f.draw()},t=function(a){var b=i.invert(h.centroid(a));f.map.center=b};return f.refresh=q,f.draw=n,f.addFeature=r,f.removeFeature=s,f.zoomToFeature=t,f},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.VectorTileLayer=function(a,b){return d3_mappu_VectorTileLayer(a,b)},d3_mappu_VectorTileLayer=function(a,b){function c(a){var b=d3.select(this);if(k)for(var c in k)b.style(c,k[c]);if(a.style)for(var c in a.style)b.style(c,a.style[c])}function d(a){return i.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1])}function e(a){var b=d3.select(this),c=d(a);h=d3.geo.mercator(),g=d3.geo.path().projection(h),this._xhr=d3.json(c,function(c,d){var e=256*Math.pow(2,a[2]);g.projection().translate([e/2-256*a[0],e/2-256*a[1]]).scale(e/2/Math.PI);{var f=d.features,h=b.selectAll("path").data(f,function(a){return a.id});h.enter().append("path").attr("id",function(a){return"entity"+a.id}).attr("d",g)}h.exit().remove()})}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vectortile";var g,h,i=b.url,j=b.duration||0,k=b.style||{};Object.defineProperty(f,"url",{get:function(){return i},set:function(a){i=a,l()}});var l=function(){var a=f.drawboard,b=f.map.tiles,d=f.map.zoombehaviour;a.transition().duration(j).attr("transform","scale("+b.scale+")translate("+b.translate+")").style("stroke-width",1/d.scale()*100);var g=a.selectAll(".tile").data(b,function(a){return a}),h=g.enter();if(f.visible){var i=1/256,k=h.append("g").attr("class","tile").attr("transform",function(a){return"translate("+a[0]+" "+a[1]+")scale("+i+")"});k.each(e),k.each(c)}g.exit().remove()},m=function(){l(),f.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return f.refresh=m,f.draw=l,f},d3_mappu_VectorTileLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.TWKBLayer=function(a,b){return d3_mappu_TWKBLayer(a,b)},d3_mappu_TWKBLayer=function(a,b){function c(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function d(a){var b=d3.select(this),d=o(a);i=d3.geo.mercator(),h=d3.geo.path().projection(i);var f=d3.json(d,function(d,f){{var g=e.map.tiles,i=256*Math.pow(2,a[2]);(a[0]+g.translate[0])*g.scale,(a[1]+g.translate[1])*g.scale,g.scale/256}h.projection().translate([i/2-256*a[0],i/2-256*a[1]]).scale(i/2/Math.PI);var j=[];f.data.forEach(function(a){if(!a.geom)return void console.warn("no data",a);var b=new Uint8Array(a.geom.data),d=new twkb.toGeoJSON(b);d.features.forEach(function(b){b.id=a.id,b.properties={},l.forEach(function(c){b.properties[c]=a[c]}),"Polygon"!=b.geometry.type||c(b.geometry.coordinates[0])||b.geometry.coordinates[0].reverse()}),j=j.concat(d.features)});var k=b.append("xhtml:canvas").attr("width",1).attr("height",1).style("border","1px solid #c3c3c3"),m=k.node().getContext("2d");h.context(m),m.save(),m.fillStyle="#FF0000",m.fillRect(0,0,150,75),m.stroke(),m.restore()});b[0][0].xhr=f,m.push(f)}b=b||{},d3_mappu_Layer.call(this,a,b);var e=d3_mappu_Layer(a,b);e.type="vector";var f=b.url,g=b;e.options=g,e.visibility=e.visible;var h,i,j=b.layers,k=(b.classproperty,b.id_column),l=b.attributes,m=(b.duration||0,b.style||{},[]);Object.defineProperty(e,"url",{get:function(){return f},set:function(a){f=a,p()}}),Object.defineProperty(e,"layers",{get:function(){return j},set:function(a){j=a,p()}}),e.clear=function(){};var n=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},o=function(a){var b;f.indexOf("?")<0&&(f+="?");var c=n(a);return b=f+"&bbox="+c+"&table="+j+"&id_column="+k+"&attributes="+l+"&srs=EPSG:3857"},p=function(){var a=e.drawboard,b=e.map.tiles;m=[];var c=b.translate.map(function(a){return Math.round(100*a)/100});a.attr("transform","scale("+Math.round(100*b.scale)/100+") translate("+c+")");var f=a.selectAll(".tile").data(b,function(a){return a}),g=f.enter();if(e.visible){var h=g.append("foreignObject").classed("tile",!0).attr("width",1).attr("height",1).attr("opacity",this.opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]});h.each(d)}f.exit().each(function(){d3.select(this)[0][0].xhr.abort()}).remove()},q=function(){p(),e.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return e.refresh=q,e.draw=p,e},d3_mappu_TWKBLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){d3_mappu_Layer.call(this,a,b);var c=d3_mappu_Layer(a,b);c.type="raster";var d=b.url,e=b.ogc_type||"tms",f=b;c.options=f,c.visibility=c.visible;var g=b.layers,h=null;Object.defineProperty(c,"url",{get:function(){return d},set:function(a){d=a,k()}}),Object.defineProperty(c,"layers",{get:function(){return g},set:function(a){g=a,k()}}),Object.defineProperty(c,"cql_filter",{get:function(){return h},set:function(a){h=a,k()}}),c.clear=function(){};var i=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},j=function(a){var b;if("tms"==e)b=d.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1]);else if("wmts"==e)d.indexOf("?")<0&&(d+="?"),b=d+"&layer="+g+"&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&STYLE=default&TILEMATRIXSET=nltilingschema&TILEMATRIX="+a[2]+"&TILEROW="+a[1]+"&TILECOL="+a[0]+"&FORMAT=image%2Fpng";else if("wms"==e){d.indexOf("?")<0&&(d+="?");var c=i(a);b=d+"&bbox="+c+"&layers="+g+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:3857&transparent=TRUE&format=image%2Fpng",h&&(b+="&cql_filter="+h)}else if("esri"==e){d.indexOf("?")<0&&(d+="?");var c=i(a);b=d+"f=image&transparent=true&format=png8&bbox="+c+"&bboxSR=102100&imageSR=102100&size=256,256"}return b},k=function(){var a=c.drawboard,b=c.map.tiles,d=b.translate.map(function(a){return Math.round(100*a)/100});a.select("g").attr("transform","scale("+Math.round(100*b.scale)/100+") translate("+d+")");var e=a.select("g").selectAll(".tile").data(b,function(a){return a}),f=e.enter();c.visible&&f.append("image").classed("tile",!0).attr("xlink:href",j).attr("width",1).attr("height",1).attr("opacity",this.opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}),e.exit().attr("xlink:href","").remove()},l=function(){k(),c.drawboard.select("g").style("opacity",this.opacity).style("display",this.visible?"block":"none")};return c.refresh=l,c.draw=k,c},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.Controllers=function(a){return d3_mappu_Controllers(a)},d3_mappu_Controllers=function(a){var b=d3.behavior.drag().on("drag",function(){console.log("Drag",d3.mouse(this))}).on("dragend",function(){console.log("Dragend",d3.mouse(this))});a.svg.call(b)},d3.mappu.Coordinates=function(a){return d3_mappu_Coordinates(a)},d3_mappu_Coordinates=function(){var a={};return a.addTo=function(a){var b=d3.select(a.mapdiv).append("div").classed("coordinates",!0);a.svg.on("mousemove",function(){var c=d3.mouse(this),d=a.projection.invert(c);b.html("lat: "+Math.round(100*d[0])/100+"| lon: "+Math.round(100*d[1])/100)})},a};