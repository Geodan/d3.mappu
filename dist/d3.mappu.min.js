/*! d3.mappu VERSION: 0.0.1 01-09-2016 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){c.POINT=1,c.LINESTRING=2,c.POLYGON=3,c.MULTIPOINT=4,c.MULTILINESTRING=5,c.MULTIPOLYGON=6,c.COLLECTION=7},{}],2:[function(a,b,c){function d(a){for(var b,c=a.cursor,d=0,e=0;;){if(b=a.buffer[c],0===(128&b))return c++,a.cursor=c,d|b<<e;d|=(127&b)<<e,c++,e+=7}}function e(a){var b=d(a);return f(b)}function f(a){return 0===(1&a)?a>>1:-(a>>1)-1}c.ReadVarInt64=d,c.ReadVarSInt64=e,c.unzigzag=f},{}],3:[function(a,b,c){function d(a,b,c){c=c||Number.MAX_VALUE;for(var d={buffer:a,cursor:void 0===b?0:b,bufferLength:a.byteLength||a.length,refpoint:new Int32Array(4)},f=[],g=0;d.cursor<d.bufferLength&&c>g;){var h=e(d,c);h.length>0?f.push({type:d.type,offset:c<Number.MAX_VALUE?d.cursor:void 0,bbox:d.has_bbox?d.bbox:void 0,coordinates:h}):(h.bbox=d.has_bbox?d.bbox:void 0,f.push(h)),g++}return f}var e=a("./readBuffer");b.exports=d},{"./readBuffer":4}],4:[function(a,b,c){function d(a,b){var c,d=0,f=0;c=a.buffer[a.cursor],a.cursor++;var g=p((240&c)>>4);a.type=15&c,a.factors=[],a.factors[0]=a.factors[1]=Math.pow(10,g),c=a.buffer[a.cursor],a.cursor++,a.has_bbox=1&c,a.has_size=(2&c)>>1,a.has_idlist=(4&c)>>2,a.is_empty=(16&c)>>4;var h=(8&c)>>3;if(h){var i=a.buffer[a.cursor];a.cursor++,d=1&i,f=(2&i)>>1;var j=(28&i)>>2,k=(224&i)>>5;d&&(a.factors[2]=Math.pow(10,j)),f&&(a.factors[2+d]=Math.pow(10,k)),a.has_z=d,a.has_m=f}var l=2+d+f;if(a.ndims=l,a.has_size&&(a.size=n(a)),a.has_bbox){for(var m=[],q=0;l-1>=q;q++){var r=o(a),s=r+o(a);m[q]=r,m[q+l]=s}a.bbox=m}return e(a,b)}function e(a,b){for(var c=a.type,d=0;d<a.ndims;d++)a.refpoint[d]=0;if(c===m.POINT)return f(a);if(c===m.LINESTRING)return g(a);if(c===m.POLYGON)return h(a);if(c===m.MULTIPOINT)return i(a,f);if(c===m.MULTILINESTRING)return i(a,g);if(c===m.MULTIPOLYGON)return i(a,h);if(c===m.COLLECTION)return j(a,b);throw new Error("Unknown type: "+c)}function f(a){return k(a,1)}function g(a){const b=n(a);return k(a,b)}function h(a){for(var b=[],c=n(a),d=0;c>d;++d)b[d]=g(a);return b}function i(a,b){var c=a.type,d=n(a),e=[],f=[];a.has_idlist&&(f=l(a,d));for(var g=0;d>g;g++){var h=b(a);e.push(h)}return{type:c,ids:f,geoms:e}}function j(a,b){var c=a.type,e=n(a),f=[],g=[];a.has_idlist&&(g=l(a,e));for(var h=0;e>h&&b>h;h++){var i=d(a);f.push({type:a.type,coordinates:i})}return{type:c,ids:g,ndims:a.ndims,offset:b<Number.MAX_VALUE?a.cursor:void 0,geoms:f}}function k(a,b){var c,d,e=a.ndims,f=a.factors,g=new Array(b*e);for(c=0;b>c;c++)for(d=0;e>d;d++)a.refpoint[d]+=o(a),g[e*c+d]=a.refpoint[d]/f[d];if(a.include_bbox&&!a.has_bbox)for(c=0;b>c;c++)for(d=0;e>d;d++){const h=g[d*e+c];h<a.bbox.min[d]&&(a.bbox.min[d]=h),h>a.bbox.max[d]&&(a.bbox.max[d]=h)}return g}function l(a,b){const c=[];for(var d=0;b>d;d++)c.push(o(a));return c}var m=a("./constants"),n=a("./protobuf").ReadVarInt64,o=a("./protobuf").ReadVarSInt64,p=a("./protobuf").unzigzag;b.exports=d},{"./constants":1,"./protobuf":2}],5:[function(a,b,c){function d(a,b){return{type:l[a],coordinates:b}}function e(a,b,c,d){return{type:"Feature",id:c,geometry:m[a](b,d)}}function f(a,b,c,d){return b.map(function(b,f){return e(a,b,c?c[f]:void 0,d)})}function g(a,b,c){return a.map(function(a,d){return e(a.type,a.coordinates,b?b[d]:void 0,c)})}function h(a,b){for(var c=[],d=0,e=a.length;e>d;d+=b){for(var f=[],g=0;b>g;++g)f.push(a[d+g]);c.push(f)}return c}function i(a){for(var b={buffer:a,cursor:0,bufferLength:a.byteLength||a.length,refpoint:new Int32Array(4)},c=[];b.cursor<b.bufferLength;){var d=k(b,Number.MAX_VALUE);d.geoms?c=c.concat(m[d.type](d.geoms,d.ids,b.ndims)):c.push({type:"Feature",geometry:m[b.type](d,b.ndims)})}return{type:"FeatureCollection",features:c}}var j=a("./constants"),k=a("./readBuffer"),l={};l[j.POINT]="Point",l[j.LINESTRING]="LineString",l[j.POLYGON]="Polygon";var m={};m[j.POINT]=function(a,b){return d(j.POINT,h(a,b)[0])},m[j.LINESTRING]=function(a,b){return d(j.LINESTRING,h(a,b))},m[j.POLYGON]=function(a,b){return d(j.POLYGON,a.map(function(a){return h(a,b)}))},m[j.MULTIPOINT]=function(a,b,c){return f(j.POINT,a,b,c)},m[j.MULTILINESTRING]=function(a,b,c){return f(j.LINESTRING,a,b,c)},m[j.MULTIPOLYGON]=function(a,b,c){return f(j.POLYGON,a,b,c)},m[j.COLLECTION]=function(a,b,c){return g(a,b,c)},b.exports=i},{"./constants":1,"./readBuffer":4}],6:[function(a,b,c){(function(c){var d=a("./constants"),e=a("./toGeoJSON"),f=a("./read"),g={toGeoJSON:e,read:f};for(var h in d)g[h]=d[h];b.exports=g,c.twkb=g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./constants":1,"./read":3,"./toGeoJSON":5}]},{},[6]),d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ッ-"+_ctr;return _ctr++,a},d3.mappu.Cache=function(){if(window.d3.mappu._cache)return window.d3.mappu._cache;var a={},b=[],c=new Promise(function(a,b){var c=indexedDB.deleteDatabase("d3.mappu");c.onsuccess=function(){console.log("Deleted database successfully"),a()},c.onerror=function(){console.log("Couldn't delete database"),b()},c.onblocked=function(){console.log("Couldn't delete database due to the operation being blocked"),b()}});return b.push(c),c.then(function(){var b=indexedDB.open("d3.mappu",1);b.onupgradeneeded=function(a){database=a.target.result,database.createObjectStore("ッ-0",{keyPath:"key"}),database.createObjectStore("ッ-1",{keyPath:"key"}),database.createObjectStore("ッ-2",{keyPath:"key"}),database.createObjectStore("ッ-3",{keyPath:"key"}),database.createObjectStore("ッ-4",{keyPath:"key"}),database.createObjectStore("ッ-5",{keyPath:"key"}),database.createObjectStore("ッ-6",{keyPath:"key"}),database.createObjectStore("ッ-7",{keyPath:"key"})},b.onsuccess=function(b){a.database=b.target.result},b.onerror=function(a){}}),a.runningtasks=b,window.d3.mappu._cache=a,a}(),d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){function c(a,b){var c=1<<a;s.scale(c),k.scale(s.scale()/2/Math.PI).translate(s.translate());var d=k(b),e=s.translate(),f=[e[0]+(g-d[0])-g/2,e[1]+(h-d[1])-h/2];s.translate(f)}var d,e={},f=[];d="object"==typeof a?a:document.getElementById(a),window.onresize=function(){r()};var g=d.clientWidth||2024,h=d.clientHeight||window.innerHeight||768,i=[[0,0],[1,1]],j=b.center||[0,0],k=b.projection||d3.geo.mercator(),l=b.zoom||22,m=b.maxZoom||24,n=b.minZoom||15,o=b.maxView||[[-180,90],[180,-90]],p=d3.dispatch("loaded","zoomend"),q=function(){u=t.scale(s.scale()).translate(s.translate())(),k.scale(s.scale()/2/Math.PI).translate(s.translate()),f.forEach(function(a){a.refresh(0)}),l=Math.log(s.scale())/Math.log(2);var a=[g/2,h/2];j=k.invert(a);var b=k.invert([0,h]),c=k.invert([g,0]);e.extent=[b,c],p.zoomend()},r=function(){g=d.clientWidth,h=d.clientHeight,d3.select(d).selectAll(".drawboard").attr("width",g).attr("height",h),t.size([g,h]),q()};k.scale((1<<l||4096)/2/Math.PI).translate([g/2,h/2]);var s=(k(j),d3.behavior.zoom().scale(2*k.scale()*Math.PI).scaleExtent([1<<n,1<<m]).translate([g/2,h/2]).on("zoom",q));d3.select(d).call(s);var t=d3.geo.tile().size([g,h]),u=t.scale(s.scale()).translate(s.translate())();c(l,j),r(),Object.defineProperty(e,"mapdiv",{get:function(){return d},set:function(){console.log("do not touch the mapdiv")}}),Object.defineProperty(e,"center",{get:function(){return j},set:function(a){c(l,a)}}),Object.defineProperty(e,"zoom",{get:function(){return l},set:function(a){m>=a&&a>=n?c(a,j):console.log("Zoomlevel exceeded",a,"Min:",n,"Max:",m)}}),Object.defineProperty(e,"minZoom",{get:function(){return n},set:function(a){n=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxZoom",{get:function(){return m},set:function(a){m=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxView",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(e,"projection",{get:function(){return k},set:function(a){k=a}}),Object.defineProperty(e,"extent",{get:function(){return i},set:function(a){i=a}}),Object.defineProperty(e,"tiles",{get:function(){return u},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(e,"zoombehaviour",{get:function(){return s},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(e,"layers",{get:function(){return f},set:function(){console.warn("No setting allowed for layers")}});var v=function(a){console.warn("Not implemented yet")},w=function(a){var b=[];b[0]=k([a[0],a[1]]),b[1]=k([a[2],a[3]]);var d=b[1][0]-b[0][0],e=b[1][1]-b[0][1];(b[0][0]+b[1][0])/2,(b[0][1]+b[1][1])/2,.9/Math.max(d/g,e/h);l=22,j=[a[0]+(a[2]-a[0])/2,a[1]+(a[3]-a[1])/2],c(l,j)},x=function(a){if(!a.id)return console.warn("Not a valid layer. (No ID)"),!1;var b=f.indexOf(a);return b>-1&&f.splice(b,1),f.push(a),a._onAdd(e),e},y=function(a){var b=f.indexOf(a);return b>-1&&f.splice(b,1),z(),a._onRemove(e),e},z=function(){var a=d3.select(d).selectAll(".drawboard").data(f,function(a){return a.id});a.enter().append(function(a){if("raster"==a.type)return document.createElement("div");if("vector"==a.type||"vectortile"==a.type)return document.createElementNS("http://www.w3.org/2000/svg","svg");throw"No valid type ("+a.type+" )specified for layer"}).attr("id",function(a){return a.id}).style("position","absolute").style("pointer-events","none").classed("drawboard",!0).each(function(a){a.drawboard=d3.select(this),"vector"!=a.type&&"vectortile"!=a.type||a.drawboard.append("g")}),a.exit().remove(),a.sort(function(a,b){return a.zindex-b.zindex})};return e.zoomToFeature=v,e.zoomToExtent=w,e.addLayer=x,e.removeLayer=y,e.orderLayers=z,e.redraw=q,e.resize=r,e.dispatch=p,e},d3.mappu=d3.mappu||{},d3.mappu.Sketch=function(a,b){return d3_mappu_Sketch(a,b)},d3_mappu_Sketch=function(a,b){function c(){p.selectAll(".sketch").remove(),p.append("path").attr("d",function(){return q(u)}).classed("sketch",!0).style("stroke","blue").style("fill",function(){return"LineString"==t?"none":"blue"}).style("fill-opacity",.4)}function d(a){var b=d3.mouse(this);s.push(o.projection.invert(b)),u.geometry.type="LineString",u.geometry.coordinates=s,c()}function e(){var a=d3.mouse(this);s=r.invert(a),u.id=(new Date).getTime().toString(),u.geometry.coordinates=s,c(),x()}function f(){s.pop(),s.pop(),u.geometry.type="LineString",u.geometry.coordinates=s,u.id=(new Date).getTime().toString(),c(),x()}function g(){u.geometry.type="Polygon",s.pop(),s.pop(),s.push(s[0]),u.geometry.coordinates=[s],u.id=(new Date).getTime().toString(),c(),x()}function h(){var a=u.geometry.coordinates.length,b=d3.mouse(this),d=o.projection.invert(b);a>=1&&(1==a?s[a]=d:s[a-1]=d,u.geometry.coordinates=s,c())}function i(a){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0)}function j(a){var b=d3.mouse(o.mapdiv);d3.select(this).attr("cx",b[0]).attr("cy",b[1]),"Polygon"==t?d3.select(this).classed("sketchPointInter")?(d3.select(this).classed("sketchPointInter",!1).classed("sketchPoint",!0),a.index+1==u.geometry.coordinates[0].length?u.geometry.coordinates[0].splice(1,0,a):u.geometry.coordinates[0].splice(a.index+1,0,a)):(u.geometry.coordinates[0][a.index]=r.invert(b),0===a.index&&(u.geometry.coordinates[0].pop(),u.geometry.coordinates[0].push(r.invert(b))),a.index+1==u.geometry.coordinates[0].length&&(u.geometry.coordinates[0][0]=r.invert(b))):"LineString"==t?d3.select(this).classed("sketchPointInter")?(d3.select(this).classed("sketchPointInter",!1).classed("sketchPoint",!0),u.geometry.coordinates.splice(a.index+1,0,a)):u.geometry.coordinates[a.index]=r.invert(b):"Point"==t&&(u.geometry.coordinates=r.invert(b)),l()}function k(a){d3.select(this).classed("dragging",!1),l()}function l(){if(p.selectAll(".sketch").remove(),p.append("path").attr("d",function(){return q(u)}).classed("sketch",!0).style("stroke","red").style("fill",function(){return"LineString"==t?"none":"red"}).style("fill-opacity",.4),"Point"==t)var a=[u.geometry.coordinates],b=[];else{switch(t){case"Polygon":var a=u.geometry.coordinates[0];break;case"LineString":var a=u.geometry.coordinates;break;default:console.warn(t," not supported")}a.forEach(function(a,b){a.index=b,a.fid=a.id});var b=a.map(function(b,c){if(c+1<a.length){var d=[];return d[0]=(b[0]+a[c+1][0])/2,d[1]=(b[1]+a[c+1][1])/2,d.index=b.index,d}});b.pop()}p.selectAll(".sketchPointInter").remove(),p.selectAll(".sketchPointInter").data(b).enter().append("circle").classed("sketchPointInter",!0).attr("cx",function(a){return r(a)[0]}).attr("cy",function(a){return r(a)[1]}).attr("r",10).style("stroke","steelBlue").style("fill","steelBlue").style("opacity",.5).call(y),p.selectAll(".sketchPoint").remove(),p.selectAll(".sketchPoint").data(a).enter().append("circle").classed("sketchPoint",!0).attr("cx",function(a){return r(a)[0]}).attr("cy",function(a){return r(a)[1]}).attr("r",10).style("stroke","steelBlue").style("fill","steelBlue").style("fillOpacity",.5).call(y)}function m(a){return o=a,o.sketch=n,r=o.projection,q=d3.geo.path().projection(o.projection).pointRadius(4.5),n}var n={},o=null,p=null,q=null,r=null,s=[],t=null,u=null,v=0,w=function(a){return p=d3.select(o.mapdiv).append("svg").attr("id","sketch").style("position","absolute").attr("width",o.mapdiv.clientWidth).attr("height",o.mapdiv.clientHeight).append("g"),new Promise(function(b,c){this.resolve=b,u={id:null,type:"Feature",geometry:{type:a,coordinates:[]},style:{opacity:.7},properties:{}},t=a,"Point"==t?d3.select(o.mapdiv).on("click",e):"LineString"==t?(u.style.fill="none",u.style.stroke="blue",u.style["stroke-width"]="4",u.style["stroke-linecap"]="round",d3.select(o.mapdiv).on("mousedown",d),d3.select(o.mapdiv).on("mousemove",h),d3.select(o.mapdiv).on("mousedown.doublemousedown",function(a){v++,v>1&&f(a),window.setTimeout(function(){v=0},300)})):"Polygon"==t&&(u.style.fill="blue",u.style.stroke="blue",d3.select(o.mapdiv).on("mousedown",d),d3.select(o.mapdiv).on("mousemove",h),d3.select(o.mapdiv).on("mousedown.doublemousedown",function(a){v++,v>1&&g(a),window.setTimeout(function(){v=0},300)}),d3.select(o.mapdiv).on("touchstart",function(a){pressTimer=window.setTimeout(function(){g()},500)}).on("touchmove",function(a,b){console.log(a,b)}).on("touchend",function(){clearTimeout(pressTimer)}))})},x=function(){self.resolve(u),E()},y=d3.behavior.drag().origin(function(a){return a}).on("dragstart",i).on("drag",j).on("dragend",k),z=function(a){return p=d3.select(o.mapdiv).append("svg").attr("id","sketch").style("position","absolute").attr("width",o.mapdiv.clientWidth).attr("height",o.mapdiv.clientHeight).append("g"),new Promise(function(b,c){self.resolve=b,event.stopPropagation(),d3.select(o.mapdiv).on("click",function(){l(),B()}),u=a,t=a.geometry.type,l()})},A=function(){},B=function(){self.resolve(u),E()},C=function(a){return new Promise(function(b,c){b(a),E()})},D=function(){},E=function(){p&&(p.selectAll(".sketch").remove(),p.selectAll(".sketchPoint").remove(),p.selectAll(".sketchPointInter").remove(),d3.select(o.mapdiv).select("#sketch").remove(),u=null,s=[],d3.select(o.mapdiv).on("mousemove",null),d3.select(o.mapdiv).on("click",null),d3.select(o.mapdiv).on("mousedown",null),d3.select(o.mapdiv).on("doublemousedown",null),d3.select(o.mapdiv).on("touchstart",null),d3.select(o.mapdiv).on("touchend",null))};return n.draw=w,n.startEdit=A,n.startRemove=D,n.remove=C,n.finish=E,n.edit=z,n.addTo=m,n},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a,b){b=b||{};var c,d={},e=d3.mappu.util.createID(),f=a,g=1;g=b.opacity||1;var h=!0;"boolean"!=typeof b.visible&&"true"!=b.visible&&"false"!=b.visible||(h=b.visible);var i=0,j=function(){},k=function(){},l=function(){},m=function(a){d.zindex=a},n=function(a){return a.addLayer(d),a.resize(),d};return Object.defineProperty(d,"id",{get:function(){return e},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(d,"name",{get:function(){return f},set:function(a){f=a}}),Object.defineProperty(d,"map",{get:function(){return c},set:function(a){c=a}}),Object.defineProperty(d,"opacity",{get:function(){return g},set:function(a){g=a,d.refresh(0)}}),Object.defineProperty(d,"visible",{get:function(){return h},set:function(a){h=a,d.draw(!0),d.refresh(0)}}),Object.defineProperty(d,"zindex",{get:function(){return i},set:function(a){i=a,d.map&&d.map.orderLayers()}}),d.refresh=j,d.moveUp=k,d.moveDown=l,d.addTo=n,d.setZIndex=m,d._onAdd=function(a){c=a,a.orderLayers(),d.draw();var b=new CustomEvent("layeradded",{detail:d});d.map.mapdiv.dispatchEvent(b)},d._onRemove=function(){var a=new CustomEvent("layerremoved");d.map.mapdiv.dispatchEvent(a)},d},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){function c(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function d(a){var b=d3.select(this);if(k)for(var c in k)b.select("path").style(c,k[c]);if(a.style)for(var c in a.style)b.select("path").style(c,a.style[c]);a._selected?b.append("path").attr("d",h).style("stroke","none").style("fill","red").classed("halo",!0):b.selectAll(".halo").remove()}function e(b){var d=i;if("Point"==b.geometry.type&&b.style){var e=(d(b.geometry.coordinates)[0],d(b.geometry.coordinates)[1],b.style&&b.style.width?b.style.width:k.width?k.width:32),f=b.style&&b.style.height?b.style.height:k.height?k.height:37;d3.select(this).append("g").append("image").attr("width",e).attr("height",f).style("pointer-events","visiblepainted").attr("xlink:href",function(a){return a.style.iconimg?"data:image/"+a.style.iconimg_encoding+","+a.style.iconimg_bytearray:a.style["marker-url"]?a.style["marker-url"]:void 0})}else"Polygon"!=b.geometry.type||c(b.geometry.coordinates[0])||b.geometry.coordinates[0].reverse(),d3.select(this).append("path").attr("d",h).classed(a,!0).style("pointer-events","visiblepainted");d3.select(this).append("text").classed("shadowtext",!0).attr("text-anchor","middle"),d3.select(this).append("text").classed("vectorLabel",!0).attr("text-anchor","middle")}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vector";var g=[];f.zindex=100;var h,i,j=b.duration||0,k=b.style||{},l=b.labelStyle||{},m=b.events;Object.defineProperty(f,"data",{get:function(){return g},set:function(a){g=a,n(!1)}}),Object.defineProperty(f,"events",{get:function(){return m},set:function(a){m=a}});var n=function(a){b.reproject?(i=f.map.projection,h=d3.geo.path().projection(i).pointRadius(function(a){return a.style&&a.style.radius?a.style.radius:4.5})):(i=d3.geo.mercator().scale(.5/Math.PI).translate([0,0]),h=d3.geo.path().projection(i));var c=f.drawboard;a&&c.selectAll(".entity").remove();var k=c.select("g").selectAll(".entity").data(g,function(a){return a.id}),l=k.enter().append("g").classed("entity",!0).attr("id",function(a){return"entity"+a.id});l.each(e),l.each(d),k.exit().remove(),m&&m.forEach(function(a){k.each(function(){d3.select(this).select("path").on(a.event,a.action),d3.select(this).select("image").on(a.event,a.action)})}),f.refresh(a?0:j)},o=(d3.scale.linear().range([20,20,32,32]).domain([0,21,24,30]),d3.scale.linear().range([20,20,37,37]).domain([0,21,24,30]),function(a){var c=f.drawboard;if(c.select("g").style("opacity",this.opacity).style("display",this.visible?"block":"none"),f.visible){var e=c.select("g").selectAll(".entity");if(b.reproject){var g=f.map.projection;e.select("path").transition().duration(a).attr("d",h),e.select("image").transition().duration(a).each(function(a){var b=a.style&&a.style.width?a.style.width:k.width?k.width:32,c=a.style&&a.style.height?a.style.height:k.height?k.height:37,d=g(a.geometry.coordinates)[0],e=g(a.geometry.coordinates)[1],f=b/2,h=c/2;d3.select(this).attr("x",d).attr("y",e).attr("width",b).attr("height",c),a.style&&a.style.rotate?d3.select(this.parentElement).attr("transform","translate("+-f+" "+-h+") rotate("+a.style.rotate+" "+Math.round(d+f)+"  "+Math.round(e+h)+")"):d3.select(this.parentElement).attr("transform","translate("+-f+" "+-h+")")}),b.labelfield&&e.each(function(a){var c=h.centroid(a),d=a.properties[b.labelfield];if(d3.select(this).selectAll("text").attr("x",c[0]).attr("y",c[1]-20).text(d),d3.select(this).select(".shadowtext").style("stroke-width","2.5px").style("stroke","white").style("opacity",.8),l)for(var e in l)d3.select(this).selectAll(".vectorLabel").style(e,l[e]),"opacity"==e&&d3.select(this).select(".shadowtext").style("opacity",l[e])}),e.each(d)}else{var i=f.map.zoombehaviour;c.select("g").attr("transform","translate("+i.translate()+")scale("+i.scale()+")").style("stroke-width",1/i.scale())}}else c.selectAll(".entity").remove()}),p=function(a){var b=d3.map(g,function(a){return a.id});b.set(a.id,a),g=b.values(),f.draw(!0)},q=function(a){var b=null;g.forEach(function(c,d){c.id==a.id&&(b=d)}),g.splice(b,1),f.draw()},r=function(a){var b=i.invert(h.centroid(a));f.map.center=b,f.map.redraw()};return f.refresh=o,f.draw=n,f.addFeature=p,f.removeFeature=q,f.zoomToFeature=r,f},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.VectorTileLayer=function(a,b){return d3_mappu_VectorTileLayer(a,b)},d3_mappu_VectorTileLayer=function(a,b){function c(a){var b=d3.select(this);if(k)for(var c in k)b.style(c,k[c]);if(a.style)for(var c in a.style)b.style(c,a.style[c])}function d(a){return i.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1])}function e(a){var b=d3.select(this),c=d(a);h=d3.geo.mercator(),g=d3.geo.path().projection(h),this._xhr=d3.json(c,function(c,d){var e=256*Math.pow(2,a[2]);g.projection().translate([e/2-256*a[0],e/2-256*a[1]]).scale(e/2/Math.PI);var f=d.features,h=b.selectAll("path").data(f,function(a){return a.id});h.enter().append("path").attr("id",function(a){return"entity"+a.id}).attr("d",g);h.exit().remove()})}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vectortile";var g,h,i=b.url,j=b.duration||0,k=b.style||{};Object.defineProperty(f,"url",{get:function(){return i},set:function(a){i=a,l()}});var l=function(){var a=f.drawboard,b=f.map.tiles,d=f.map.zoombehaviour;a.transition().duration(j).attr("transform","scale("+b.scale+")translate("+b.translate+")").style("stroke-width",1/d.scale()*100);var g=a.selectAll(".tile").data(b,function(a){return a}),h=g.enter();if(f.visible){var i=1/256,k=h.append("g").attr("class","tile").attr("transform",function(a){return"translate("+a[0]+" "+a[1]+")scale("+i+")"});k.each(e),k.each(c)}g.exit().remove()},m=function(){l(),f.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return f.refresh=m,f.draw=l,f},d3_mappu_VectorTileLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.TWKBLayer=function(a,b){return d3_mappu_TWKBLayer(a,b)},d3_mappu_TWKBLayer=function(a,b){function c(a,b){var c=d3.select("#T"+e.id+"_"+a[0]+"_"+a[1]+"_"+a[2]);if(c[0][0]){i=d3.geo.mercator(),h=d3.geo.path().projection(i);var d=(e.map.tiles,256*Math.pow(2,a[2]));h.projection().translate([d/2-256*a[0],d/2-256*a[1]]).scale(d/2/Math.PI);var f=c.append("canvas").attr("width",256).attr("height",256),g=f.node().getContext("2d");h.context(g),g.save(),b.forEach(function(a){g.beginPath(),h(a),g.fillStyle="function"==typeof o.fill?o.fill(a.properties[o.column]):o.fill,g.fill(),g.closePath()}),g.lineWidth=1,g.restore()}}function d(a,b){var c=a/256,d=a%1?Number:Math.round;return"matrix3d("+[c,0,0,0,0,c,0,0,0,0,c,0,d(b[0]*a),d(b[1]*a),0,1]+")"}b=b||{};var e=d3_mappu_Layer(a,b);e.type="raster";var f=b.url,g=b;e.options=g,e.visibility=e.visible;var h,i,j=b.layers,k=(b.classproperty,b.id_column),l=b.geom_column,m=b.srid,n=b.attributes,o=b.style,p=(b.duration||0,b.style||{},[]);Object.defineProperty(e,"url",{get:function(){return f},set:function(a){f=a,t()}}),Object.defineProperty(e,"layers",{get:function(){return j},set:function(a){j=a,t()}}),Object.defineProperty(e,"style",{get:function(){return o},set:function(a){o=a,e.drawboard.selectAll(".tile").remove(),e.refresh(0)}}),e.clear=function(){};var q=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},r=function(a){var b;f.indexOf("?")<0&&(f+="?");var c=q(a);return b=f+"&request=getData&bbox="+c+"&table="+j+"&id_column="+k+"&geom_column="+l+"&srid="+m+"&attributes="+n+"&srs=EPSG:3857"},s=[];s.push(new Worker("twkb_processor.js")),s.forEach(function(a){a.onmessage=function(a){if(a.data.layerid==e.id){var b=a.data.data,d=a.data.d;c(d,b)}}});var t=function(){Promise.all(d3.mappu.Cache.runningtasks).then(function(){var a=e.drawboard,b=e.map.tiles;p=[];var c=a.style("transform",d(b.scale,b.translate)).selectAll(".tile").data(b,function(a){return a}),f=c.enter();if(e.visible){var g=f.append("div").classed("tile",!0).attr("id",function(a){return"T"+e.id+"_"+a[0]+"_"+a[1]+"_"+a[2]}).style("position","absolute").style("width","256px").style("height","256px").style("left",function(a){return(a[0]<<8)+"px"}).style("top",function(a){return(a[1]<<8)+"px"});g.each(function(a){var b=r(a);s[0].postMessage({layerid:e.id,url:b,tile:a,attributes:n})})}c.exit().each(function(a){}).remove()})},u=function(){t(),e.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return e.refresh=u,e.draw=t,e},d3_mappu_TWKBLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){function c(a,b){var c=a/256,d=a%1?Number:Math.round;return"matrix3d("+[c,0,0,0,0,c,0,0,0,0,c,0,d(b[0]*a),d(b[1]*a),0,1]+")"}var d=d3_mappu_Layer(a,b);d.type="raster";var e=b.url,f=b.ogc_type||"tms",g=b.style||"",h=b;d.options=h,d.visibility=d.visible;var i=b.layers,j=null;Object.defineProperty(d,"url",{get:function(){return e},set:function(a){e=a,n()}}),Object.defineProperty(d,"layers",{get:function(){return i},set:function(a){i=a,n()}}),Object.defineProperty(d,"cql_filter",{get:function(){return j},set:function(a){j=a,n()}}),d.clear=function(){};var k=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},l=function(a){var b;if("tms"==f)b=e.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1]);else if("wmts"==f)e.indexOf("?")<0&&(e+="?"),b=e+"&layer="+i+"&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&STYLE=default&TILEMATRIXSET=nltilingschema&TILEMATRIX="+a[2]+"&TILEROW="+a[1]+"&TILECOL="+a[0]+"&FORMAT=image%2Fpng";else if("wms"==f){e.indexOf("?")<0&&(e+="?");var c=k(a);b=e+"&bbox="+c+"&styles="+g+"&layers="+i+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&width=256&height=256&srs=EPSG:3857&transparent=TRUE&format=image%2Fpng",j&&(b+="&cql_filter="+j)}else if("esri"==f){e.indexOf("?")<0&&(e+="?");var c=k(a);b=e+"f=image&transparent=true&format=png8&bbox="+c+"&bboxSR=102100&imageSR=102100&size=256,256"}return b},m=function(a){var b=d3.mouse(this),c=d3.mouse(map.mapdiv);if("wms"==f){var d=e+"?SRS=EPSG:900913&QUERY_LAYERS="+i+"&LAYERS="+i+"&INFO_FORMAT=application/json&REQUEST=GetFeatureInfo&FEATURE_COUNT=50&EXCEPTIONS=application/vnd.ogc.se_xml&SERVICE=WMS&VERSION=1.1.0&WIDTH=256&HEIGHT=256&X="+Math.round(b[0])+"&Y="+Math.round(b[1])+"&BBOX="+k(a);d3.json(d,function(a,b){var d=b.features[0];d3.select("#map").append("div").classed("popover",!0).style("left",c[0]+"px").style("top",c[1]+"px").html(d.id)})}if("esri"==f){var d=e.replace("export","identify")+"?geometryType=esriGeometryPoint&geometry={'x': "+Math.round(b[0])+",'y':"+Math.round(b[1])+"}&tolerance=10&mapExtent=-119,38,-121,41&imageDisplay=256,256,96&f=json";d3.json(d,function(a,b){(a||b.error)&&console.warn(a||b.error),console.log(b);var d=b.results[0];d3.select("#map").append("div").classed("popover",!0).style("left",c[0]+"px").style("top",c[1]+"px").html(d.id)})}},n=function(){var a=d.drawboard,b=d.map.tiles,e=a.style("transform",c(b.scale,b.translate)).selectAll(".tile").data(b,function(a){return a}),f=e.enter();d.visible&&f.append("img").classed("tile",!0).attr("src",l).style("width","256px").style("height","256px").style("position","absolute").attr("opacity",this.opacity).style("left",function(a){return(a[0]<<8)+"px"}).style("top",function(a){return(a[1]<<8)+"px"}).on("click",m),e.exit().remove()},o=function(){n(),d.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return d.refresh=o,d.draw=n,d},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.Controllers=function(a){return d3_mappu_Controllers(a)},d3_mappu_Controllers=function(a){var b=d3.behavior.drag().on("drag",function(a){console.log("Drag",d3.mouse(this))}).on("dragend",function(a,b){console.log("Dragend",d3.mouse(this))});a.svg.call(b)},d3.mappu.Coordinates=function(a){return d3_mappu_Coordinates(a)},d3_mappu_Coordinates=function(a){var b={};return b.addTo=function(a){var b=d3.select(a.mapdiv).append("div").classed("coordinates",!0);a.svg.on("mousemove",function(c){var d=d3.mouse(this),e=a.projection.invert(d);b.html("lat: "+Math.round(100*e[0])/100+"| lon: "+Math.round(100*e[1])/100)})},b};