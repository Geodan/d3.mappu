/*! d3.mappu VERSION: 0.0.1 27-01-2015 */
d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ãƒƒ-"+_ctr;return _ctr++,a},d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){function c(){u.scale((1<<l)/2/Math.PI),k.scale(u.scale()/2/Math.PI).translate(u.translate());var a=k(j),b=u.translate(),c=[b[0]+(h-a[0])-h/2,b[1]+(i-a[1])-i/2];u.translate(c),e._duration=2e3,e.redraw()}var d,e={},f=[],g=0;e._duration=g,d="object"==typeof a?a:document.getElementById(a),window.onresize=function(){console.log("Map resize detected"),q()};var h=d.clientWidth||2024,i=d.clientHeight||window.innerHeight||768,j=b.center||[0,0],k=b.projection||d3.geo.mercator(),l=b.zoom||22,m=b.maxZoom||24,n=b.minZoom||15,o=b.maxView||[[-180,90],[180,-90]],p=function(){w=v.scale(u.scale()).translate(u.translate())(),k.scale(u.scale()/2/Math.PI).translate(u.translate()),f.forEach(function(a){a.refresh()}),e._duration=0},q=function(){h=d.clientWidth,i=d.clientHeight,d3.select(d).select("svg").attr("width",h).attr("height",i),k.translate([h/2,i/2]),u.translate([h-s[0],i-s[1]]),v.size([h,i]),p()},r=d3.select(d).append("svg").style("position","absolute");k.scale((l<<12||4096)/2/Math.PI).translate([h/2,i/2]);var s=k(j),t=d3.geo.path().projection(k),u=d3.behavior.zoom().scale(2*k.scale()*Math.PI).scaleExtent([1<<n,1<<m]).translate([h-s[0],i-s[1]]).on("zoom",p);d3.select(d).call(u),k.scale(.5/Math.PI).translate([0,0]);var v=d3.geo.tile().size([h,i]),w=v.scale(u.scale()).translate(u.translate())();q(),Object.defineProperty(e,"svg",{get:function(){return r},set:function(){console.log("do not touch the svg")}}),Object.defineProperty(e,"size",{get:function(){return[i,h]},set:function(a){i=a[0],h=a[1],v=d3.geo.tile().size([h,i]),d3.select(d).select("svg").attr("width",h).attr("height",i),e.redraw()}}),Object.defineProperty(e,"mapdiv",{get:function(){return d},set:function(){console.log("do not touch the mapdiv")}}),Object.defineProperty(e,"canvasdiv",{get:function(){return _canvasdiv},set:function(){console.log("do not touch the canvasdiv")}}),Object.defineProperty(e,"zoom",{get:function(){return l},set:function(a){m>=a&&a>=n?(l=a,c()):console.log("Zoomlevel exceeded",n,m)}}),Object.defineProperty(e,"minZoom",{get:function(){return n},set:function(a){n=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxZoom",{get:function(){return m},set:function(a){m=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxView",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(e,"center",{get:function(){var a=[h/2,i/2];return k.invert(a)},set:function(a){j=a,c()}}),Object.defineProperty(e,"projection",{get:function(){return k},set:function(a){k=a,t=d3.geo.path().projection(k)}}),Object.defineProperty(e,"path",{get:function(){return t},set:function(){console.warn("No setting allowed for path")}}),Object.defineProperty(e,"tiles",{get:function(){return w},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(e,"zoombehaviour",{get:function(){return u},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(e,"layers",{get:function(){return f},set:function(){console.warn("No setting allowed for layers")}});var x=function(a){return a.id?(f.forEach(function(b){return b.id==a.id?(b=a,e):void 0}),f.push(a),a._onAdd(e),e):(console.warn("Not a valid layer. (No ID)"),!1)},y=function(a){return f.forEach(function(b,c){return b.id==a?(f.splice(c,1),e):void 0}),e};return e.addLayer=x,e.removeLayer=y,e.redraw=p,e},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a,b){var c,d={},e=d3.mappu.util.createID(),f=a,g=1,h=!0;"boolean"==typeof b.visible&&(h=b.visible);var i=function(){},j=function(){},k=function(){},l=function(a){return c=a,d.drawboard=c.svg.append("g"),c.addLayer(d),d.draw(),d};return Object.defineProperty(d,"id",{get:function(){return e},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(d,"name",{get:function(){return f},set:function(a){f=a}}),Object.defineProperty(d,"map",{get:function(){return c},set:function(a){c=a}}),Object.defineProperty(d,"opacity",{get:function(){return g},set:function(a){g=a,d.refresh()}}),Object.defineProperty(d,"visible",{get:function(){return h},set:function(a){h=a,d.refresh()}}),d.refresh=i,d.moveUp=j,d.moveDown=k,d.addTo=l,d._onAdd=function(a){c=a,d.drawboard=c.svg.append("g"),d.draw()},d._onRemove=function(){},d},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){function c(a){var b=d3.select(this);if(a.style)for(var c in a.style)b.style(c,a.style[c])}d3_mappu_Layer.call(this,a,b);var d=d3_mappu_Layer(a,b),e=[];Object.defineProperty(d,"data",{get:function(){return e},set:function(a){e=a,f(!0)}});var f=function(f){var g=d.drawboard;f&&g.selectAll(".entity").remove();var h=g.selectAll(".entity").data(e),i=h.enter().append("path").attr("d",d.map.path).classed("entity",!0).classed(a,!0).style("stroke","blue").each(c);b.events&&b.events.forEach(function(a){i.on(a.event,a.action)}),d.refresh()},g=function(){var a=d.drawboard;if(a.style("opacity",this.opacity).style("display",this.visible?"block":"none"),b.reproject){var e=a.selectAll(".entity");e.transition().duration(d.map._duration).attr("d",d.map.path).each(c)}else{var f=d.map.zoombehaviour;a.attr("transform","translate("+f.translate()+")scale("+f.scale()+")").style("stroke-width",1/f.scale())}};return d.refresh=g,d.draw=f,d},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){d3_mappu_Layer.call(this,a,b);var c=d3_mappu_Layer(a,b),d=b.url,e=b.ogc_type||"tms",f=b.layers;Object.defineProperty(c,"url",{get:function(){return d},set:function(a){d=a,j()}}),Object.defineProperty(c,"layers",{get:function(){return f},set:function(a){f=a,j()}}),c.clear=function(){};var g=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},h=function(a){var b;if("tms"==e)b=d.replace("{s}",["a","b","c","d"][4*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][4*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1]);else if("wms"==e){var c=g(a);b=d+"&bbox="+c+"&layers="+f+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:3857&transparent=TRUE&format=image%2Fpng"}return b},i=function(a){return},j=function(){var a=c.drawboard,b=c.map.tiles;a.transition().duration(c.map._duration).attr("transform","scale("+b.scale+")translate("+b.translate+")");var d=a.selectAll(".tile").data(b,function(a){return a}),e=d.enter();e.append("image").classed("tile",!0).attr("xlink:href",h).attr("width",1).attr("height",1).attr("opacity",this.opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}).on("click",i),d.exit().remove()},k=function(){j(),c.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return c.refresh=k,c.draw=j,c},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.Controllers=function(a){return d3_mappu_Controllers(a)},d3_mappu_Controllers=function(a){var b=d3.behavior.drag().on("drag",function(){console.log("Drag",d3.mouse(this))}).on("dragend",function(){console.log("Dragend",d3.mouse(this))});a.svg.call(b)},d3.mappu.Coordinates=function(a){return d3_mappu_Coordinates(a)},d3_mappu_Coordinates=function(){var a={};return a.addTo=function(a){var b=d3.select(a.mapdiv).append("div").classed("coordinates",!0);a.svg.on("mousemove",function(){var c=d3.mouse(this),d=a.projection.invert(c);b.html("lat: "+Math.round(100*d[0])/100+"| lon: "+Math.round(100*d[1])/100)})},a};