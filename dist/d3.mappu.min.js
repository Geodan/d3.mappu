/*! d3.mappu VERSION: 0.0.1 31-10-2014 */
d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ãƒƒ-"+_ctr;return _ctr++,a},d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){var c={},d=[],e=e||1024,f=f||768,g=d3.select(a).append("svg").attr("width",e).attr("height",f),h=b.center||[0,0],i=b.projection||d3.geo.mercator(),j=b.zoom||10,k=b.maxZoom||24,l=b.minZoom||15,m=b.maxView,n=function(){s=r.scale(q.scale()).translate(q.translate())(),i.scale(q.scale()/2/Math.PI).translate(q.translate()),d.forEach(function(a){a.refresh()})};i.scale((j<<12||4096)/2/Math.PI).translate([e/2,f/2]);var o=i(h),p=d3.geo.path().projection(i),q=d3.behavior.zoom().scale(2*i.scale()*Math.PI).scaleExtent([1<<l,1<<k]).translate([e-o[0],f-o[1]]).on("zoom",n);g.call(q),i.scale(.5/Math.PI).translate([0,0]);var r=d3.geo.tile().size([e,f]),s=r.scale(q.scale()).translate(q.translate())();Object.defineProperty(c,"svg",{get:function(){return g},set:function(){console.log("do not touch the svg")}}),Object.defineProperty(c,"zoom",{get:function(){return void 0===j?0:j},set:function(a){j=a}}),Object.defineProperty(c,"minZoom",{get:function(){return void 0===l?0:l},set:function(a){l=a}}),Object.defineProperty(c,"maxZoom",{get:function(){return void 0===k?13:k},set:function(a){k=a}}),Object.defineProperty(c,"maxView",{get:function(){return void 0===m?[[-180,90],[180,-90]]:m},set:function(a){m=a}}),Object.defineProperty(c,"center",{get:function(){return void 0===h?[0,0]:h},set:function(a){h=a}}),Object.defineProperty(c,"projection",{get:function(){return void 0===i?d3.geo.mercator():i},set:function(a){i=a,p=d3.geo.path().projection(i)}}),Object.defineProperty(c,"path",{get:function(){return p},set:function(){console.warn("No setting allowed for path")}}),Object.defineProperty(c,"tiles",{get:function(){return s},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(c,"zoombehaviour",{get:function(){return q},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(c,"layers",{get:function(){return d},set:function(){console.warn("No setting allowed for layers")}});var t=function(a){return a.id?(d.forEach(function(b){return b.id==a.id?(b=a,c):void 0}),d.push(a),a._onAdd(c),c):(console.warn("Not a valid layer. (No ID)"),!1)},u=function(a){return d.forEach(function(b,e){return b.id==a?(d.splice(e,1),c):void 0}),c};return c.addLayer=t,c.removeLayer=u,c.draw=n,c},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a){var b={},c=(new Date).getTime(),d=a,e=1,f=!0;this._display="block";var g=function(){},h=function(){},i=function(){},j=function(a){return a=a,b.drawboard=a.svg.append("g"),a.addLayer(b),b};return Object.defineProperty(b,"id",{get:function(){return c},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(b,"name",{get:function(){return d},set:function(a){d=a}}),Object.defineProperty(b,"opacity",{get:function(){return e},set:function(a){e=a,b.refresh()}}),Object.defineProperty(b,"visible",{get:function(){return f},set:function(a){this._display=a?"block":"none",f=a,b.refresh()}}),b.refresh=g,b.moveUp=h,b.moveDown=i,b.addTo=j,b._onAdd=function(a){a=a,drawboard=a.svg.append("g")},b._onRemove=function(){},b},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){var c=this;d3_mappu_Layer.call(this,a,b);var d,e=d3_mappu_Layer(a,b),f=[];Object.defineProperty(e,"data",{get:function(){return f},set:function(a){f=a,g(!0)}});var g=function(d){var g=e.drawboard;d&&g.selectAll(".entity").remove();var h=g.selectAll(".entity").data(f),i=h.enter().append("path").attr("d",c.map.path).classed("entity",!0).classed(a,!0);b.events&&b.events.forEach(function(a){i.on(a.event,a.action)}),e.refresh()},h=function(){var a=c.map.zoombehaviour;if(e.drawboard.style("opacity",this.opacity).style("display",this._display),b.reproject){var f=d.selectAll(".entity");f.attr("d",mypath)}else e.drawboard.attr("transform","translate("+a.translate()+")scale("+a.scale()+")").style("stroke-width",1/a.scale())};return e.refresh=h,e.draw=g,e},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){var c=this;d3_mappu_Layer.call(this,a,b);var d=d3_mappu_Layer(a,b),e=b.url;Object.defineProperty(d,"url",{get:function(){return e},set:function(a){e=a,f()}}),d.clear=function(){};var f=function(){var a=d.drawboard,b=c.map.tiles;a.attr("transform","scale("+b.scale+")translate("+b.translate+")");var f=a.selectAll(".tile").data(b,function(a){return a}),g=f.enter();g.append("image").classed("tile",!0).attr("xlink:href",function(a){var b="";return b=e.replace("{s}",["a","b","c","d"][4*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][4*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1])}).attr("width",1).attr("height",1).attr("opacity",c._opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}),f.exit().remove()},g=function(){f(),d.drawboard.style("opacity",this.opacity).style("display",this._display)};return d.refresh=g,d.draw=f,d},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype);