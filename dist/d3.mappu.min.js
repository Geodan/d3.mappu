/*! d3.mappu VERSION: 0.0.1 23-12-2014 */
d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ãƒƒ-"+_ctr;return _ctr++,a},d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){var c,d={},e=[];c="object"==typeof a?a:document.getElementById(a);var f=c.clientWidth||2024,g=c.clientHeight||768,h=1,i=d3.select(c).style("width",f+"px").style("height",g+"px").append("div").style("transform","scale("+1/h+")").style("transform-origin","0 0 0"),j=d3.select(c).append("svg").style("position","absolute").attr("width",f).attr("height",g),k=b.center||[0,0],l=b.projection||d3.geo.mercator(),m=b.zoom||22,n=b.maxZoom||24,o=b.minZoom||15,p=b.maxView||[[-180,90],[180,-90]],q=function(){v=u.scale(t.scale()).translate(t.translate())(),l.scale(t.scale()/2/Math.PI).translate(t.translate()),e.forEach(function(a){a.refresh()})};l.scale((m<<12||4096)/2/Math.PI).translate([f/2,g/2]);var r=l(k),s=d3.geo.path().projection(l),t=d3.behavior.zoom().scale(2*l.scale()*Math.PI).scaleExtent([1<<o,1<<n]).translate([f-r[0],g-r[1]]).on("zoom",q);d3.select(c).call(t),l.scale(.5/Math.PI).translate([0,0]);var u=d3.geo.tile().size([f,g]),v=u.scale(t.scale()).translate(t.translate())();Object.defineProperty(d,"svg",{get:function(){return j},set:function(){console.log("do not touch the svg")}}),Object.defineProperty(d,"size",{get:function(){return[g,f]},set:function(a){g=a[0],f=a[1],u=d3.geo.tile().size([f,g]),d3.select(c).select("svg").attr("width",f).attr("height",g),d.redraw()}}),Object.defineProperty(d,"mapdiv",{get:function(){return c},set:function(){console.log("do not touch the mapdiv")}}),Object.defineProperty(d,"canvasdiv",{get:function(){return i},set:function(){console.log("do not touch the canvasdiv")}}),Object.defineProperty(d,"zoom",{get:function(){return m},set:function(a){n>=a&&a>=o?(m=a,t.scale((1<<a)/2/Math.PI),l.scale(t.scale()/2/Math.PI).translate(t.translate()),this.center=k):console.log("Zoomlevel exceeded",a)}}),Object.defineProperty(d,"minZoom",{get:function(){return o},set:function(a){o=a,this.zoombehaviour.scaleExtent([1<<o,1<<n])}}),Object.defineProperty(d,"maxZoom",{get:function(){return n},set:function(a){n=a,this.zoombehaviour.scaleExtent([1<<o,1<<n])}}),Object.defineProperty(d,"maxView",{get:function(){return p},set:function(a){p=a}}),Object.defineProperty(d,"center",{get:function(){var a=[f/2,g/2];return l.invert(a)},set:function(a){k=a;var b=l(a),c=t.translate();t.translate([c[0]+(f-b[0])-f/2,c[1]+(g-b[1])-g/2]),this.redraw()}}),Object.defineProperty(d,"projection",{get:function(){return l},set:function(a){l=a,s=d3.geo.path().projection(l)}}),Object.defineProperty(d,"path",{get:function(){return s},set:function(){console.warn("No setting allowed for path")}}),Object.defineProperty(d,"tiles",{get:function(){return v},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(d,"zoombehaviour",{get:function(){return t},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(d,"layers",{get:function(){return e},set:function(){console.warn("No setting allowed for layers")}});var w=function(a){return a.id?(e.forEach(function(b){return b.id==a.id?(b=a,d):void 0}),e.push(a),a._onAdd(d),d):(console.warn("Not a valid layer. (No ID)"),!1)},x=function(a){return e.forEach(function(b,c){return b.id==a?(e.splice(c,1),d):void 0}),d};return d.addLayer=w,d.removeLayer=x,d.redraw=q,d},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a){var b,c={},d=d3.mappu.util.createID(),e=a,f=1,g=!0,h=function(){},i=function(){},j=function(){},k=function(a){return b=a,c.drawboard=b.svg.append("g"),b.addLayer(c),c.draw(),c};return Object.defineProperty(c,"id",{get:function(){return d},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(c,"name",{get:function(){return e},set:function(a){e=a}}),Object.defineProperty(c,"map",{get:function(){return b},set:function(a){b=a}}),Object.defineProperty(c,"opacity",{get:function(){return f},set:function(a){f=a,c.refresh()}}),Object.defineProperty(c,"visible",{get:function(){return g},set:function(a){g=a,c.refresh()}}),c.refresh=h,c.moveUp=i,c.moveDown=j,c.addTo=k,c._onAdd=function(a){b=a,c.drawboard=b.svg.append("g"),c.draw()},c._onRemove=function(){},c},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){d3_mappu_Layer.call(this,a,b);var c=d3_mappu_Layer(a,b),d=[];Object.defineProperty(c,"data",{get:function(){return d},set:function(a){d=a,e(!0)}});var e=function(e){var f=c.drawboard;e&&f.selectAll(".entity").remove();var g=f.selectAll(".entity").data(d),h=g.enter().append("path").attr("d",c.map.path).classed("entity",!0).classed(a,!0);b.events&&b.events.forEach(function(a){h.on(a.event,a.action)}),c.refresh()},f=function(){var a=c.map.zoombehaviour,d=c.drawboard;if(d.style("opacity",this.opacity).style("display",this.visible?"block":"none"),b.reproject){var e=d.selectAll(".entity");e.attr("d",c.map.path)}else d.attr("transform","translate("+a.translate()+")scale("+a.scale()+")").style("stroke-width",1/a.scale())};return c.refresh=f,c.draw=e,c},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){d3_mappu_Layer.call(this,a,b);var c=d3_mappu_Layer(a,b),d=b.url,e=b.ogc_type||"tms",f=b.layers;Object.defineProperty(c,"url",{get:function(){return d},set:function(a){d=a,j()}}),Object.defineProperty(c,"layers",{get:function(){return f},set:function(a){f=a,j()}}),c.clear=function(){};var g=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},h=function(a){var b;if("tms"==e)b=d.replace("{s}",["a","b","c","d"][4*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][4*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1]);else if("wms"==e){var c=g(a);b=d+"&bbox="+c+"&layers="+f+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:900913&transparent=TRUE&format=image%2Fpng"}return b},i=function(a){return},j=function(){var a=c.drawboard,b=c.map.tiles;a.attr("transform","scale("+b.scale+")translate("+b.translate+")");var d=a.selectAll(".tile").data(b,function(a){return a}),e=d.enter();e.append("image").classed("tile",!0).attr("xlink:href",h).attr("width",1).attr("height",1).attr("opacity",this.opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}).on("click",i),d.exit().remove()},k=function(){j(),c.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return c.refresh=k,c.draw=j,c},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.Controllers=function(a){return d3_mappu_Controllers(a)},d3_mappu_Controllers=function(a){var b=d3.behavior.drag().on("drag",function(){console.log("Drag",d3.mouse(this))}).on("dragend",function(){console.log("Dragend",d3.mouse(this))});a.svg.call(b)},d3.mappu.Coordinates=function(a){return d3_mappu_Coordinates(a)},d3_mappu_Coordinates=function(){var a={};return a.addTo=function(a){var b=d3.select(a.mapdiv).append("div").classed("coordinates",!0);a.svg.on("mousemove",function(){var c=d3.mouse(this),d=a.projection.invert(c);b.html("lat: "+Math.round(100*d[0])/100+"| lon: "+Math.round(100*d[1])/100)})},a};