/*! d3.mappu VERSION: 0.0.1 06-12-2015 */
d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ãƒƒ-"+_ctr;return _ctr++,a},d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){function c(a,b){var c=1<<a;u.scale(c),k.scale(u.scale()/2/Math.PI).translate(u.translate());var d=k(b),e=u.translate(),f=[e[0]+(g-d[0])-g/2,e[1]+(h-d[1])-h/2];u.translate(f),u.event(s.transition())}var d,e={},f=[];d="object"==typeof a?a:document.getElementById(a),window.onresize=function(){r()};var g=d.clientWidth||2024,h=d.clientHeight||window.innerHeight||768,i=[[0,0],[1,1]],j=b.center||[0,0],k=b.projection||d3.geo.mercator(),l=b.zoom||22,m=b.maxZoom||24,n=b.minZoom||15,o=b.maxView||[[-180,90],[180,-90]],p=d3.dispatch("loaded","zoomend"),q=function(){k.scale(u.scale()/2/Math.PI).translate(u.translate()),l=Math.log(u.scale())/Math.log(2);var a=[g/2,h/2];j=k.invert(a),w=v.scale(u.scale()).translate(u.translate())(),f.forEach(function(a){a.refresh(0)});var b=k.invert([0,d.clientHeight]),c=k.invert([d.clientWidth,0]);e.extent=[b,c],p.zoomend()},r=function(){g=d.clientWidth,h=d.clientHeight,d3.select(d).select("svg").attr("width",g).attr("height",h),v.size([g,h]),q()},s=d3.select(d).append("svg").style("position","absolute");k.scale((1<<l||4096)/2/Math.PI).translate([g/2,h/2]);var t=k(j),u=d3.behavior.zoom().scale(2*k.scale()*Math.PI).scaleExtent([1<<n,1<<m]).translate([g-t[0],h-t[1]]).on("zoom",q);d3.select(d).call(u);var v=d3.geo.tile().size([g,h]),w=v.scale(u.scale()).translate(u.translate())();c(l,j),r(),Object.defineProperty(e,"svg",{get:function(){return s},set:function(){console.log("do not touch the svg")}}),Object.defineProperty(e,"mapdiv",{get:function(){return d},set:function(){console.log("do not touch the mapdiv")}}),Object.defineProperty(e,"canvasdiv",{get:function(){return _canvasdiv},set:function(){console.log("do not touch the canvasdiv")}}),Object.defineProperty(e,"center",{get:function(){return j},set:function(a){c(l,a)}}),Object.defineProperty(e,"zoom",{get:function(){return l},set:function(a){m>=a&&a>=n?c(a,j):console.log("Zoomlevel exceeded",a,"Min:",n,"Max:",m)}}),Object.defineProperty(e,"minZoom",{get:function(){return n},set:function(a){n=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxZoom",{get:function(){return m},set:function(a){m=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxView",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(e,"projection",{get:function(){return k},set:function(a){k=a}}),Object.defineProperty(e,"extent",{get:function(){return i},set:function(a){i=a}}),Object.defineProperty(e,"tiles",{get:function(){return w},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(e,"zoombehaviour",{get:function(){return u},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(e,"layers",{get:function(){return f},set:function(){console.warn("No setting allowed for layers")}});var x=function(){console.warn("Not implemented yet")},y=function(a){if(!a.id)return console.warn("Not a valid layer. (No ID)"),!1;var b=f.indexOf(a);return b>-1&&f.splice(b,1),f.push(a),a._onAdd(e),e},z=function(a){var b=f.indexOf(a);return b>-1&&f.splice(b,1),A(),a._onRemove(e),e},A=function(){var a=s.selectAll(".drawboard").data(f,function(a){return a.id});a.enter().append("g").attr("id",function(a){return a.id}).classed("drawboard",!0).each(function(a){a.drawboard=d3.select(this);var b=a.drawboard.append("defs").append("filter").attr("id","glow");b.append("feGaussianBlur").attr("stdDeviation","2.5").attr("result","coloredBlur");var c=b.append("feMerge");c.append("feMergeNode").attr("in","coloredBlur"),c.append("feMergeNode").attr("in","SourceGraphic")}),a.exit().remove(),a.sort(function(a,b){return a.zindex-b.zindex})};return e.zoomToFeature=x,e.addLayer=y,e.removeLayer=z,e.orderLayers=A,e.redraw=q,e.resize=r,e.dispatch=p,e},d3.mappu=d3.mappu||{},d3.mappu.Sketch=function(a,b){return d3_mappu_Sketch(a,b)},d3_mappu_Sketch=function(){function a(){n.selectAll(".sketch").remove(),n.append("path").attr("d",function(){return o(s)}).classed("sketch",!0).style("stroke","blue").style("fill",function(){return"LineString"==r?"none":"blue"}).style("fill-opacity",.4)}function b(){var b=d3.mouse(this);q.push(m.projection.invert(b)),s.geometry.type="LineString",s.geometry.coordinates=q,a()}function c(){var b=d3.mouse(this);q=p.invert(b),s.id=(new Date).getTime().toString(),s.geometry.coordinates=q,a(),v()}function d(){q.pop(),q.pop(),s.geometry.type="LineString",s.geometry.coordinates=q,s.id=(new Date).getTime().toString(),a(),v()}function e(){s.geometry.type="Polygon",q.pop(),q.pop(),q.push(q[0]),s.geometry.coordinates=[q],s.id=(new Date).getTime().toString(),a(),v()}function f(){var b=s.geometry.coordinates.length,c=d3.mouse(this),d=m.projection.invert(c);b>=1&&(1==b?q[b]=d:q[b-1]=d,s.geometry.coordinates=q,a())}function g(){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0)}function h(a){var b=d3.mouse(m.mapdiv);d3.select(this).attr("cx",b[0]).attr("cy",b[1]),"Polygon"==r?d3.select(this).classed("sketchPointInter")?(d3.select(this).classed("sketchPointInter",!1).classed("sketchPoint",!0),a.index+1==s.geometry.coordinates[0].length?s.geometry.coordinates[0].splice(1,0,a):s.geometry.coordinates[0].splice(a.index+1,0,a)):(s.geometry.coordinates[0][a.index]=p.invert(b),0===a.index&&(s.geometry.coordinates[0].pop(),s.geometry.coordinates[0].push(p.invert(b))),a.index+1==s.geometry.coordinates[0].length&&(s.geometry.coordinates[0][0]=p.invert(b))):"LineString"==r?d3.select(this).classed("sketchPointInter")?(d3.select(this).classed("sketchPointInter",!1).classed("sketchPoint",!0),s.geometry.coordinates.splice(a.index+1,0,a)):s.geometry.coordinates[a.index]=p.invert(b):"Point"==r&&(s.geometry.coordinates=p.invert(b)),j()}function i(){d3.select(this).classed("dragging",!1),j()}function j(){if(n.selectAll(".sketch").remove(),n.append("path").attr("d",function(){return o(s)}).classed("sketch",!0).style("stroke","red").style("fill",function(){return"LineString"==r?"none":"red"}).style("fill-opacity",.4),"Point"==r)var a=[s.geometry.coordinates],b=[];else{switch(r){case"Polygon":var a=s.geometry.coordinates[0];break;case"LineString":var a=s.geometry.coordinates;break;default:console.warn(r," not supported")}a.forEach(function(a,b){a.index=b,a.fid=a.id});var b=a.map(function(b,c){if(c+1<a.length){var d=[];return d[0]=(b[0]+a[c+1][0])/2,d[1]=(b[1]+a[c+1][1])/2,d.index=b.index,d}});b.pop()}n.selectAll(".sketchPointInter").remove(),n.selectAll(".sketchPointInter").data(b).enter().append("circle").classed("sketchPointInter",!0).attr("cx",function(a){return p(a)[0]}).attr("cy",function(a){return p(a)[1]}).attr("r",10).style("stroke","steelBlue").style("fill","steelBlue").style("opacity",.5).call(w),n.selectAll(".sketchPoint").remove(),n.selectAll(".sketchPoint").data(a).enter().append("circle").classed("sketchPoint",!0).attr("cx",function(a){return p(a)[0]}).attr("cy",function(a){return p(a)[1]}).attr("r",10).style("stroke","steelBlue").style("fill","steelBlue").style("fillOpacity",.5).call(w)}function k(a){return m=a,n=m.svg,p=m.projection,o=d3.geo.path().projection(m.projection).pointRadius(4.5),l}var l={},m=null,n=null,o=null,p=null,q=[],r=null,s=null,t=0,u=function(a){return new Promise(function(g){this.resolve=g,s={id:null,type:"Feature",geometry:{type:a,coordinates:[]},style:{opacity:.7},properties:{}},r=a,"Point"==r?m.svg.on("click",c):"LineString"==r?(s.style.fill="none",s.style.stroke="blue",s.style["stroke-width"]="4",s.style["stroke-linecap"]="round",m.svg.on("mousedown",b),m.svg.on("mousemove",f),m.svg.on("mousedown.doublemousedown",function(a){t++,t>1&&d(a),window.setTimeout(function(){t=0},300)})):"Polygon"==r&&(s.style.fill="blue",s.style.stroke="blue",m.svg.on("mousedown",b),m.svg.on("mousemove",f),m.svg.on("mousedown.doublemousedown",function(a){t++,t>1&&e(a),window.setTimeout(function(){t=0},300)}),m.svg.on("touchstart",function(){pressTimer=window.setTimeout(function(){e()},500)}).on("touchmove",function(a,b){console.log(a,b)}).on("touchend",function(){clearTimeout(pressTimer)}))})},v=function(){self.resolve(s),C()},w=d3.behavior.drag().origin(function(a){return a}).on("dragstart",g).on("drag",h).on("dragend",i),x=function(a){return new Promise(function(b){self.resolve=b,event.stopPropagation(),m.svg.on("click",function(){j(),z()}),s=a,r=a.geometry.type,j()})},y=function(){},z=function(){self.resolve(s),C()},A=function(a){self.resolve(a),C()},B=function(){},C=function(){n.selectAll(".sketch").remove(),n.selectAll(".sketchPoint").remove(),n.selectAll(".sketchPointInter").remove(),s=null,q=[],m.svg.on("mousemove",null),m.svg.on("click",null),m.svg.on("mousedown",null),m.svg.on("doublemousedown",null),m.svg.on("touchstart",null),m.svg.on("touchend",null)};return l.draw=u,l.startEdit=y,l.startRemove=B,l.remove=A,l.finish=C,l.edit=x,l.addTo=k,l},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a,b){b=b||{};var c,d={},e=d3.mappu.util.createID(),f=a,g=1;g=b.opacity||1;var h=!0;("boolean"==typeof b.visible||"true"==b.visible||"false"==b.visible)&&(h=b.visible);var i=0,j=function(){},k=function(){},l=function(){},m=function(a){d.zindex=a},n=function(a){return a.addLayer(d),d};return Object.defineProperty(d,"id",{get:function(){return e},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(d,"name",{get:function(){return f},set:function(a){f=a}}),Object.defineProperty(d,"map",{get:function(){return c},set:function(a){c=a}}),Object.defineProperty(d,"opacity",{get:function(){return g},set:function(a){g=a,d.refresh(0)}}),Object.defineProperty(d,"visible",{get:function(){return h},set:function(a){h=a,d.draw(!0),d.refresh(0)}}),Object.defineProperty(d,"zindex",{get:function(){return i},set:function(a){i=a,d.map&&d.map.orderLayers()}}),d.refresh=j,d.moveUp=k,d.moveDown=l,d.addTo=n,d.setZIndex=m,d._onAdd=function(a){c=a,a.orderLayers(),d.draw();var b=new CustomEvent("layeradded",{detail:d});d.map.mapdiv.dispatchEvent(b)},d._onRemove=function(){var a=new CustomEvent("layerremoved");d.map.mapdiv.dispatchEvent(a)},d},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){function c(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function d(a){var b=d3.select(this);if(k)for(var c in k)b.select("path").style(c,k[c]);if(a.style)for(var c in a.style)b.select("path").style(c,a.style[c]);a._selected?b.append("path").attr("d",h).style("stroke","none").style("fill","red").classed("halo",!0):b.selectAll(".halo").remove()}function e(b){var d=i;if("Point"==b.geometry.type&&b.style&&b.style["marker-url"]){d(b.geometry.coordinates)[0],d(b.geometry.coordinates)[1],d3.select(this).append("image").attr("width",32).attr("height",37).attr("xlink:href",function(a){return a.style["marker-url"]})}else"Polygon"!=b.geometry.type||c(b.geometry.coordinates[0])||b.geometry.coordinates[0].reverse(),d3.select(this).append("path").attr("d",h).classed(a,!0);d3.select(this).append("text").classed("shadowtext",!0).attr("text-anchor","middle"),d3.select(this).append("text").classed("vectorLabel",!0).attr("text-anchor","middle")}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vector";var g=[];f.zindex=100;var h,i,j=b.duration||0,k=b.style||{},l=b.labelStyle||{},m=b.events;Object.defineProperty(f,"data",{get:function(){return g},set:function(a){g=a,n(!1)}}),Object.defineProperty(f,"events",{get:function(){return m},set:function(a){m=a}});var n=function(a){b.reproject?(i=f.map.projection,h=d3.geo.path().projection(i).pointRadius(function(a){return a.style&&a.style.radius?a.style.radius:4.5})):(i=d3.geo.mercator().scale(.5/Math.PI).translate([0,0]),h=d3.geo.path().projection(i));var c=f.drawboard;a&&c.selectAll(".entity").remove();var k=c.selectAll(".entity").data(g,function(a){return a.id}),l=k.enter().append("g").classed("entity",!0).attr("id",function(a){return"entity"+a.id});l.each(e),l.each(d),k.exit().remove(),m&&m.forEach(function(a){k.each(function(){d3.select(this).select("path").on(a.event,a.action),d3.select(this).select("image").on(a.event,a.action)})}),f.refresh(a?0:j)},o=d3.scale.linear().range([20,20,32,32]).domain([0,21,24,30]),p=d3.scale.linear().range([20,20,37,37]).domain([0,21,24,30]),q=function(a){var c=f.drawboard;if(c.style("opacity",this.opacity).style("display",this.visible?"block":"none"),f.visible){var e=c.selectAll(".entity");if(b.reproject){var g=f.map.projection;e.select("path").transition().duration(a).attr("d",h),e.select("image").transition().duration(a).attr("x",function(a){return g(a.geometry.coordinates)[0]-12.5}).attr("y",function(a){return g(a.geometry.coordinates)[1]-15}).attr("width",o(f.map.zoom)).attr("height",p(f.map.zoom)),b.labelfield&&(f.map.zoom<22?e.selectAll("text").text(""):e.each(function(a){var c=h.centroid(a),d=a.properties[b.labelfield];d3.select(this).selectAll("text").attr("x",c[0]).attr("y",c[1]-20).text(d);for(var e in l)d3.select(this).selectAll("text").style(e,l[e]);d3.select(this).select(".shadowtext").style("stroke-width","2.5px").style("stroke","white").style("opacity",.8)})),e.each(d)}else{var i=f.map.zoombehaviour;c.attr("transform","translate("+i.translate()+")scale("+i.scale()+")").style("stroke-width",1/i.scale())}}else c.selectAll(".entity").remove()},r=function(a){var b=d3.map(g,function(a){return a.id});b.set(a.id,a),g=b.values(),f.draw(!0)},s=function(a){var b=null;g.forEach(function(c,d){c.id==a.id&&(b=d)}),g.splice(b,1),f.draw()},t=function(a){var b=i.invert(h.centroid(a));f.map.center=b};return f.refresh=q,f.draw=n,f.addFeature=r,f.removeFeature=s,f.zoomToFeature=t,f},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.VectorTileLayer=function(a,b){return d3_mappu_VectorTileLayer(a,b)},d3_mappu_VectorTileLayer=function(a,b){function c(a){var b=d3.select(this);if(k)for(var c in k)b.style(c,k[c]);if(a.style)for(var c in a.style)b.style(c,a.style[c])}function d(a){return i.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1])}function e(a){var b=d3.select(this),c=d(a);h=d3.geo.mercator(),g=d3.geo.path().projection(h),this._xhr=d3.json(c,function(c,d){var e=256*Math.pow(2,a[2]);g.projection().translate([e/2-256*a[0],e/2-256*a[1]]).scale(e/2/Math.PI);{var f=d.features,h=b.selectAll("path").data(f,function(a){return a.id});h.enter().append("path").attr("id",function(a){return"entity"+a.id}).attr("d",g)}h.exit().remove()})}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vectortile";var g,h,i=b.url,j=b.duration||0,k=b.style||{};Object.defineProperty(f,"url",{get:function(){return i},set:function(a){i=a,l()}});var l=function(){var a=f.drawboard,b=f.map.tiles,d=f.map.zoombehaviour;a.transition().duration(j).attr("transform","scale("+b.scale+")translate("+b.translate+")").style("stroke-width",1/d.scale()*100);var g=a.selectAll(".tile").data(b,function(a){return a}),h=g.enter();if(f.visible){var i=1/256,k=h.append("g").attr("class","tile").attr("transform",function(a){return"translate("+a[0]+" "+a[1]+")scale("+i+")"});k.each(e),k.each(c)}g.exit().remove()},m=function(){l(),f.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return f.refresh=m,f.draw=l,f},d3_mappu_VectorTileLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){d3_mappu_Layer.call(this,a,b);var c=d3_mappu_Layer(a,b);c.type="raster";var d=b.url,e=b.ogc_type||"tms",f=b;c.options=f,c.visibility=c.visible;var g=b.layers,h=0;Object.defineProperty(c,"url",{get:function(){return d},set:function(a){d=a,k()}}),Object.defineProperty(c,"layers",{get:function(){return g},set:function(a){g=a,k()}}),c.clear=function(){};var i=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},j=function(a){var b;if("tms"==e)b=d.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1]);else if("wmts"==e)d.indexOf("?")<0&&(d+="?"),b=d+"&layer="+g+"&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&STYLE=default&TILEMATRIXSET=nltilingschema&TILEMATRIX="+a[2]+"&TILEROW="+a[1]+"&TILECOL="+a[0]+"&FORMAT=image%2Fpng";else if("wms"==e){d.indexOf("?")<0&&(d+="?");var c=i(a);b=d+"&bbox="+c+"&layers="+g+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:3857&transparent=TRUE&format=image%2Fpng"}else if("esri"==e){d.indexOf("?")<0&&(d+="?");var c=i(a);b=d+"f=image&transparent=true&format=png8&bbox="+c+"&bboxSR=102100&imageSR=102100&size=256,256"}return b},k=function(){var a=c.drawboard,b=c.map.tiles;a.transition().duration(h).attr("transform","scale("+b.scale+")translate("+b.translate+")");var d=a.selectAll(".tile").data(b,function(a){return a}),e=d.enter();c.visible&&e.append("image").classed("tile",!0).attr("xlink:href",j).attr("width",1).attr("height",1).attr("opacity",this.opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}),d.exit().attr("xlink:href","").remove()},l=function(){k(),c.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return c.refresh=l,c.draw=k,c},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.Controllers=function(a){return d3_mappu_Controllers(a)},d3_mappu_Controllers=function(a){var b=d3.behavior.drag().on("drag",function(){console.log("Drag",d3.mouse(this))}).on("dragend",function(){console.log("Dragend",d3.mouse(this))});a.svg.call(b)},d3.mappu.Coordinates=function(a){return d3_mappu_Coordinates(a)},d3_mappu_Coordinates=function(){var a={};return a.addTo=function(a){var b=d3.select(a.mapdiv).append("div").classed("coordinates",!0);a.svg.on("mousemove",function(){var c=d3.mouse(this),d=a.projection.invert(c);b.html("lat: "+Math.round(100*d[0])/100+"| lon: "+Math.round(100*d[1])/100)})},a};