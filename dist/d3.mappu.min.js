/*! d3.mappu VERSION: 0.0.1 13-04-2015 */
d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ãƒƒ-"+_ctr;return _ctr++,a},d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){function c(a,b){var c=(1<<a)/2/Math.PI;t.scale(c),k.scale(t.scale()/2/Math.PI).translate(t.translate());var d=k(b),e=t.translate(),f=[e[0]+(g-d[0])-g/2,e[1]+(h-d[1])-h/2];t.translate(f),t.event(r.transition())}var d,e={},f=[];d="object"==typeof a?a:document.getElementById(a),window.onresize=function(){q()};var g=d.clientWidth||2024,h=d.clientHeight||window.innerHeight||768,i=[[0,0],[1,1]],j=b.center||[0,0],k=b.projection||d3.geo.mercator(),l=b.zoom||22,m=b.maxZoom||24,n=b.minZoom||15,o=b.maxView||[[-180,90],[180,-90]],p=function(){k.scale(t.scale()/2/Math.PI).translate(t.translate()),console.log("zoom 1:",l),l=Math.log(t.scale())/Math.log(2),console.log("zoom 2:",l);var a=[g/2,h/2];j=k.invert(a),v=u.scale(t.scale()).translate(t.translate())(),console.log("scale: ",t.scale()),f.forEach(function(a){a.refresh(0)});var b=k.invert([0,d.clientHeight]),c=k.invert([d.clientWidth,0]);e.extent=[b,c]},q=function(){g=d.clientWidth,h=d.clientHeight,d3.select(d).select("svg").attr("width",g).attr("height",h),u.size([g,h]),p()},r=d3.select(d).append("svg").style("position","absolute");k.scale((1<<l||4096)/2/Math.PI).translate([g/2,h/2]);var s=k(j),t=d3.behavior.zoom().scale(2*k.scale()*Math.PI).scaleExtent([1<<n,1<<m]).translate([g-s[0],h-s[1]]).on("zoom",p);d3.select(d).call(t);var u=d3.geo.tile().size([g,h]),v=u.scale(t.scale()).translate(t.translate())();q(),Object.defineProperty(e,"svg",{get:function(){return r},set:function(){console.log("do not touch the svg")}}),Object.defineProperty(e,"mapdiv",{get:function(){return d},set:function(){console.log("do not touch the mapdiv")}}),Object.defineProperty(e,"canvasdiv",{get:function(){return _canvasdiv},set:function(){console.log("do not touch the canvasdiv")}}),Object.defineProperty(e,"center",{get:function(){return j},set:function(a){c(l,a)}}),Object.defineProperty(e,"zoom",{get:function(){return l},set:function(a){m>=a&&a>=n?c(a,j):console.log("Zoomlevel exceeded",a,"Min:",n,"Max:",m)}}),Object.defineProperty(e,"minZoom",{get:function(){return n},set:function(a){n=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxZoom",{get:function(){return m},set:function(a){m=a,this.zoombehaviour.scaleExtent([1<<n,1<<m])}}),Object.defineProperty(e,"maxView",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(e,"projection",{get:function(){return k},set:function(a){k=a}}),Object.defineProperty(e,"extent",{get:function(){return i},set:function(a){i=a}}),Object.defineProperty(e,"tiles",{get:function(){return v},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(e,"zoombehaviour",{get:function(){return t},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(e,"layers",{get:function(){return f},set:function(){console.warn("No setting allowed for layers")}});var w=function(){console.warn("Not implemented yet")},x=function(a){if(!a.id)return console.warn("Not a valid layer. (No ID)"),!1;var b=f.indexOf(a);return b>-1&&f.splice(b,1),f.push(a),a._onAdd(e),e},y=function(a){var b=f.indexOf(a);return f.splice(b,1),z(),e},z=function(){var a=r.selectAll(".drawboard").data(f,function(a){return a.id});a.enter().append("g").attr("id",function(a){return a.id}).classed("drawboard",!0).each(function(a){a.drawboard=d3.select(this)}),a.exit().remove(),a.sort(function(a,b){return a.zindex-b.zindex})};return e.zoomToFeature=w,e.addLayer=x,e.removeLayer=y,e.orderLayers=z,e.redraw=p,e.resize=q,e},d3.mappu=d3.mappu||{},d3.mappu.Sketch=function(a,b){return d3_mappu_Sketch(a,b)},d3_mappu_Sketch=function(a,b){function c(){q.selectAll(".sketch").remove(),q.append("path").attr("d",function(){return r(v)}).classed("sketch",!0).style("stroke","blue").style("fill",function(){return"LineString"==u?"none":"blue"}).style("fill-opacity",.4).on("dblclick",function(){"LineString"==u&&f(),"Polygon"==u&&g()})}function d(){var a=d3.mouse(this);t.push(p.projection.invert(a)),v.geometry.type="LineString",v.geometry.coordinates=t,c()}function e(){var a=d3.mouse(this);t=s.invert(a),v.geometry.coordinates=t,c(),x()}function f(){t.pop(),t.pop(),v.geometry.type="LineString",v.geometry.coordinates=t,c(),x()}function g(){v.geometry.type="Polygon",t.pop(),t.pop(),t.push(t[0]),v.geometry.coordinates=[t],c(),x()}function h(){var a=v.geometry.coordinates.length,b=d3.mouse(this),d=p.projection.invert(b);a>=1&&(1==a?t[a]=d:t[a-1]=d,v.geometry.coordinates=t,c())}function i(){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0)}function j(a){var b=d3.mouse(p.mapdiv);d3.select(this).attr("cx",b[0]).attr("cy",b[1]),"Polygon"==u?(v.geometry.coordinates[0][a.index]=s.invert(b),0===a.index&&(v.geometry.coordinates[0].pop(),v.geometry.coordinates[0].push(s.invert(b))),a.index+1==v.geometry.coordinates[0].length&&(v.geometry.coordinates[0][0]=s.invert(b))):"LineString"==u?v.geometry.coordinates[a.index]=s.invert(b):"Point"==u&&(v.geometry.coordinates=s.invert(b)),l()}function k(){d3.select(this).classed("dragging",!1),l()}function l(){if(q.selectAll(".sketch").remove(),q.append("path").attr("d",function(){return r(v)}).classed("sketch",!0).style("stroke","red").style("fill",function(){return"LineString"==u?"none":"red"}).style("fill-opacity",.4),"Polygon"==u){var a=v.geometry.coordinates[0];a.forEach(function(a,b){a.index=b,a.fid=a.id});var b=a.map(function(b,c){if(c+1<a.length){var d=[];return d[0]=(b[0]+a[c+1][0])/2,d[1]=(b[1]+a[c+1][1])/2,d.index=b.index,d}});b.pop()}else if("LineString"==u){var a=v.geometry.coordinates;a.forEach(function(a,b){a.index=b,a.fid=a.id});var b=a.map(function(b,c){if(c+1<a.length){var d=[];return d[0]=(b[0]+a[c+1][0])/2,d[1]=(b[1]+a[c+1][1])/2,d.index=b.index,d}});b.pop()}else if("Point"==u)var a=[v.geometry.coordinates],b=[];q.selectAll(".sketchPointInter").remove(),q.selectAll(".sketchPointInter").data(b).enter().append("circle").classed("sketchPointInter",!0).attr("cx",function(a){return s(a)[0]}).attr("cy",function(a){return s(a)[1]}).attr("r",40).style("stroke","steelBlue").style("fill","steelBlue").style("opacity",.5).on("click",function(a){event.stopPropagation(),"Polygon"==u?(a.index+1==v.geometry.coordinates[0].length?v.geometry.coordinates[0].splice(1,0,a):v.geometry.coordinates[0].splice(a.index+1,0,a),l()):"LineString"==u&&(v.geometry.coordinates.splice(a.index+1,0,a),l())}),q.selectAll(".sketchPoint").remove(),q.selectAll(".sketchPoint").data(a).enter().append("circle").classed("sketchPoint",!0).attr("cx",function(a){return s(a)[0]}).attr("cy",function(a){return s(a)[1]}).attr("r",40).style("stroke","steelBlue").style("fill","steelBlue").style("fillOpacity",.5).call(y)}function m(a){event.stopPropagation(),p.svg.on("click",function(){l(),A()}),v=a,u=a.geometry.type,l()}var n={},o=b.layer;if("vector"!=o.type)return console.warn("Can't edit. Not a vector layer"),null;var p=o.map,q=o.map.svg,r=d3.geo.path().projection(o.map.projection).pointRadius(4.5),s=p.projection,t=[],u=null,v=null,w=function(a){v={id:(new Date).getTime().toString(),type:"Feature",geometry:{type:a,coordinates:[]},style:{opacity:.7},properties:{}},u=a,"Point"==u?p.svg.on("click",e):"LineString"==u?(v.style.fill="none",p.svg.on("click",d),p.svg.on("mousemove",h),p.svg.on("dblclick",f)):"Polygon"==u&&(v.style.fill="blue",p.svg.on("click",d),p.svg.on("mousemove",h),p.svg.on("dblclick",g),p.svg.on("touchstart",function(){pressTimer=window.setTimeout(function(){alert("long press!"),g()},500)}).on("touchend",function(){clearTimeout(pressTimer)}))},x=function(){o.addFeature(v);var a=new CustomEvent("featureCreated",{detail:v});p.mapdiv.dispatchEvent(a),D()},y=d3.behavior.drag().origin(function(a){return a}).on("dragstart",i).on("drag",j).on("dragend",k),z=function(){o.drawboard.selectAll(".entity").select("path").on("click",m)},A=function(){o.addFeature(v);var a=new CustomEvent("featureChanged",{detail:v});p.mapdiv.dispatchEvent(a),D()},B=function(a){o.removeFeature(a);var b=new CustomEvent("featureRemoved",{detail:a});p.mapdiv.dispatchEvent(b),D()},C=function(){o.drawboard.selectAll(".entity").select("path").on("click",B)},D=function(){q.selectAll(".sketch").remove(),q.selectAll(".sketchPoint").remove(),q.selectAll(".sketchPointInter").remove(),o.drawboard.selectAll(".entity").select("path").on("click",null),v=null,t=[],p.svg.on("mousemove",null),p.svg.on("click",null),p.svg.on("click",null),p.svg.on("dblclick",null),p.svg.on("dblclick",null),p.svg.on("touchstart",null),p.svg.on("touchend",null),o.draw(!0)};return n.draw=w,n.startEdit=z,n.startRemove=C,n.finish=D,n},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a,b){b=b||{};var c,d={},e=d3.mappu.util.createID(),f=a,g=1,h=!0;("boolean"==typeof b.visible||"true"==b.visible||"false"==b.visible)&&(h=b.visible);var i=0,j=function(){},k=function(){},l=function(){},m=function(a){d.zindex=a},n=function(a){return a.addLayer(d),d};return Object.defineProperty(d,"id",{get:function(){return e},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(d,"name",{get:function(){return f},set:function(a){f=a}}),Object.defineProperty(d,"map",{get:function(){return c},set:function(a){c=a}}),Object.defineProperty(d,"opacity",{get:function(){return g},set:function(a){g=a,d.refresh(0)}}),Object.defineProperty(d,"visible",{get:function(){return h},set:function(a){h=a,d.draw(!0),d.refresh(0)}}),Object.defineProperty(d,"zindex",{get:function(){return i},set:function(a){i=a,d.map&&d.map.orderLayers()}}),d.refresh=j,d.moveUp=k,d.moveDown=l,d.addTo=n,d.setZIndex=m,d._onAdd=function(a){c=a,a.orderLayers(),d.draw()},d._onRemove=function(){},d},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){function c(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function d(a){var b=d3.select(this);if(k)for(var c in k)b.select("path").style(c,k[c]);if(a.style)for(var c in a.style)b.select("path").style(c,a.style[c]);a._selected?b.append("path").attr("d",h).style("stroke","none").style("fill","red").classed("halo",!0):b.selectAll(".halo").remove()}function e(b){var d=i;if("Point"==b.geometry.type&&b.style&&b.style["marker-url"]){var e=d(b.geometry.coordinates)[0],f=d(b.geometry.coordinates)[1];d3.select(this).append("image").attr("width",32).attr("height",37).attr("x",e-12.5).attr("y",f-25).attr("xlink:href",function(a){return a.style["marker-url"]})}else"Polygon"!=b.geometry.type||c(b.geometry.coordinates[0])||b.geometry.coordinates[0].reverse(),d3.select(this).append("path").attr("d",h).classed(a,!0);d3.select(this).append("text")}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vector";var g=[];f.zindex=100;var h,i,j=b.duration||0,k=b.style||{},l=b.events;Object.defineProperty(f,"data",{get:function(){return g},set:function(a){g=a,m(!1)}}),Object.defineProperty(f,"events",{get:function(){return l},set:function(a){l=a}});var m=function(a){b.reproject?(i=f.map.projection,h=d3.geo.path().projection(i).pointRadius(function(a){return a.style&&a.style.radius?a.style.radius:4.5})):(i=d3.geo.mercator().scale(.5/Math.PI).translate([0,0]),h=d3.geo.path().projection(i));var c=f.drawboard;a&&c.selectAll(".entity").remove();var k=c.selectAll(".entity").data(g,function(a){return a.id}),m=k.enter().append("g").classed("entity",!0).attr("id",function(a){return"entity"+a.id});m.each(e),m.each(d),k.exit().remove(),l&&l.forEach(function(a){m.select("path").on(a.event,a.action),m.select("image").on(a.event,a.action)}),f.refresh(a?0:j)},n=function(a){console.log("refreshing",f.name);var c=f.drawboard;if(c.style("opacity",this.opacity).style("display",this.visible?"block":"none"),f.visible){var e=c.selectAll(".entity");if(b.reproject){var g=f.map.projection;e.select("path").transition().duration(a).attr("d",h),e.select("image").transition().duration(a).attr("x",function(a){return g(a.geometry.coordinates)[0]}).attr("y",function(a){return g(a.geometry.coordinates)[1]}),b.labelfield&&e.each(function(a){var c=h.centroid(a),d=a.properties[b.labelfield];d3.select(this).select("text").attr("x",c[0]).attr("y",c[1]).classed("vectorLabel",!0).attr("text-anchor","middle").text(d)}),e.each(d)}else{var i=f.map.zoombehaviour;c.attr("transform","translate("+i.translate()+")scale("+i.scale()+")").style("stroke-width",1/i.scale())}}else c.selectAll(".entity").remove()},o=function(a){var b=!1;g.forEach(function(c){return c.id==a.id?(c=a,f.draw(),void(b=!0)):void 0}),b||g.push(a),f.draw(!0)},p=function(a){var b=null;g.forEach(function(c,d){c.id==a.id&&(b=d)}),g.splice(b,1),f.draw()};return f.refresh=n,f.draw=m,f.addFeature=o,f.removeFeature=p,f},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){d3_mappu_Layer.call(this,a,b);var c=d3_mappu_Layer(a,b);c.type="raster";var d=b.url,e=b.ogc_type||"tms",f=b;c.options=f,c.visibility=c.visible;var g=b.layers,h=0;Object.defineProperty(c,"url",{get:function(){return d},set:function(a){d=a,l()}}),Object.defineProperty(c,"layers",{get:function(){return g},set:function(a){g=a,l()}}),c.clear=function(){};var i=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},j=function(a){var b;if("tms"==e)b=d.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1]);else if("wmts"==e)b=d+"?&layer="+g+"&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&STYLE=default&TILEMATRIXSET=nltilingschema&TILEMATRIX="+a[2]+"&TILEROW="+a[1]+"&TILECOL="+a[0]+"&FORMAT=image%2Fpng";else if("wms"==e){var c=i(a);b=d+"?&bbox="+c+"&layers="+g+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:3857&transparent=TRUE&format=image%2Fpng"}return b},k=function(a){return},l=function(){var a=c.drawboard,b=c.map.tiles;a.transition().duration(h).attr("transform","scale("+b.scale+")translate("+b.translate+")");var d=a.selectAll(".tile").data(b,function(a){return a}),e=d.enter();c.visible&&e.append("image").classed("tile",!0).attr("xlink:href",j).attr("width",1).attr("height",1).attr("opacity",this.opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}).on("click",k),d.exit().remove()},m=function(){l(),c.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return c.refresh=m,c.draw=l,c},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.Controllers=function(a){return d3_mappu_Controllers(a)},d3_mappu_Controllers=function(a){var b=d3.behavior.drag().on("drag",function(){console.log("Drag",d3.mouse(this))}).on("dragend",function(){console.log("Dragend",d3.mouse(this))});a.svg.call(b)},d3.mappu.Coordinates=function(a){return d3_mappu_Coordinates(a)},d3_mappu_Coordinates=function(){var a={};return a.addTo=function(a){var b=d3.select(a.mapdiv).append("div").classed("coordinates",!0);a.svg.on("mousemove",function(){var c=d3.mouse(this),d=a.projection.invert(c);b.html("lat: "+Math.round(100*d[0])/100+"| lon: "+Math.round(100*d[1])/100)})},a};