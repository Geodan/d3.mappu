/*! d3.mappu VERSION: 0.0.1 27-02-2015 */
d3.mappu=d3.mappu||{},d3.mappu.util={};var _ctr=0;d3.mappu.util.createID=function(){var a="ãƒƒ-"+_ctr;return _ctr++,a},d3.mappu=d3.mappu||{},d3.mappu.Map=function(a,b){return d3_mappu_Map(a,b)},d3_mappu_Map=function(a,b){function c(a,b){var c=(1<<a)/2/Math.PI;s.scale(c),j.scale(s.scale()/2/Math.PI).translate(s.translate());var d=j(b),e=s.translate(),f=[e[0]+(g-d[0])-g/2,e[1]+(h-d[1])-h/2];s.translate(f),s.event(q.transition())}var d,e={},f=[];d="object"==typeof a?a:document.getElementById(a),window.onresize=function(){p()};var g=d.clientWidth||2024,h=d.clientHeight||window.innerHeight||768,i=b.center||[0,0],j=b.projection||d3.geo.mercator(),k=b.zoom||22,l=b.maxZoom||24,m=b.minZoom||15,n=b.maxView||[[-180,90],[180,-90]],o=function(){j.scale(s.scale()/2/Math.PI).translate(s.translate());var a=s.scale();k=Math.log(2*a*Math.PI)/Math.log(2);var b=[g/2,h/2];i=j.invert(b),u=t.scale(s.scale()).translate(s.translate())(),f.forEach(function(a){a.refresh(0)})},p=function(){g=d.clientWidth,h=d.clientHeight,d3.select(d).select("svg").attr("width",g).attr("height",h),t.size([g,h]),o()},q=d3.select(d).append("svg").style("position","absolute");j.scale((k<<12||4096)/2/Math.PI).translate([g/2,h/2]);var r=j(i),s=d3.behavior.zoom().scale(2*j.scale()*Math.PI).scaleExtent([1<<m,1<<l]).translate([g-r[0],h-r[1]]).on("zoom",o);d3.select(d).call(s),j.scale(.5/Math.PI).translate([0,0]);var t=d3.geo.tile().size([g,h]),u=t.scale(s.scale()).translate(s.translate())();p(),Object.defineProperty(e,"svg",{get:function(){return q},set:function(){console.log("do not touch the svg")}}),Object.defineProperty(e,"mapdiv",{get:function(){return d},set:function(){console.log("do not touch the mapdiv")}}),Object.defineProperty(e,"canvasdiv",{get:function(){return _canvasdiv},set:function(){console.log("do not touch the canvasdiv")}}),Object.defineProperty(e,"center",{get:function(){return i},set:function(a){c(k,a)}}),Object.defineProperty(e,"zoom",{get:function(){return k},set:function(a){l>=a&&a>=m?c(a,i):console.log("Zoomlevel exceeded",a,"Min:",m,"Max:",l)}}),Object.defineProperty(e,"minZoom",{get:function(){return m},set:function(a){m=a,this.zoombehaviour.scaleExtent([1<<m,1<<l])}}),Object.defineProperty(e,"maxZoom",{get:function(){return l},set:function(a){l=a,this.zoombehaviour.scaleExtent([1<<m,1<<l])}}),Object.defineProperty(e,"maxView",{get:function(){return n},set:function(a){n=a}}),Object.defineProperty(e,"projection",{get:function(){return j},set:function(a){j=a}}),Object.defineProperty(e,"tiles",{get:function(){return u},set:function(){console.warn("No setting allowed for tile")}}),Object.defineProperty(e,"zoombehaviour",{get:function(){return s},set:function(){console.warn("No setting allowed for zoombehaviour")}}),Object.defineProperty(e,"layers",{get:function(){return f},set:function(){console.warn("No setting allowed for layers")}});var v=function(){console.warn("Not implemented yet")},w=function(a){return a.id?(f.forEach(function(b){return b.id==a.id?(b=a,e):void 0}),f.push(a),a._onAdd(e),e):(console.warn("Not a valid layer. (No ID)"),!1)},x=function(a){return f.forEach(function(b,c){return b.id==a?(f.splice(c,1),e):void 0}),e},y=function(a){var b=[];return f.forEach(function(c){c.name==a&&b.push(c)}),b};return e.zoomToFeature=v,e.addLayer=w,e.removeLayer=x,e.getLayersByName=y,e.redraw=o,e.resize=p,e},d3.mappu=d3.mappu||{},d3.mappu.Sketch=function(a,b){return d3_mappu_Sketch(a,b)},d3_mappu_Sketch=function(a,b){function c(){n.selectAll(".sketch").remove(),n.append("path").attr("d",function(){return o(s)}).classed("sketch",!0).style("stroke","blue").style("fill",function(){return"LineString"==r?"none":"blue"}).style("fill-opacity",.4).on("dblclick",function(){"LineString"==r&&f(),"Polygon"==r&&g()})}function d(){var a=d3.mouse(this);q.push(m.projection.invert(a)),s.geometry.type="LineString",s.geometry.coordinates=q,c()}function e(){var a=d3.mouse(this);q=p.invert(a),s.geometry.coordinates=q,c(),w()}function f(){s.geometry.type="LineString",s.geometry.coordinates=q,c(),w()}function g(){s.geometry.type="Polygon",q.push(q[0]),s.geometry.coordinates=[q],c(),w()}function h(){var a=s.geometry.coordinates.length,b=d3.mouse(this),d=m.projection.invert(b);a>=1&&(1==a?q[a]=d:q[a-1]=d,s.geometry.coordinates=q,c())}function i(){if(n.selectAll(".sketch").remove(),n.append("path").attr("d",function(){return o(s)}).classed("sketch",!0).style("stroke","red").style("fill",function(){return"LineString"==r?"none":"red"}).style("fill-opacity",.4),"Polygon"==s.geometry.type)var a=s.geometry.coordinates[0];n.selectAll(".sketchPoint").remove(),n.selectAll(".sketchPoint").data(a).enter().append("circle").attr("cx",function(a){return p(a)[0]}).attr("cy",function(a){return p(a)[1]}).attr("r",10).style("stroke","green").style("fill","green")}function j(a){s=a,i()}var k={},l=b.layer;if("vector"!=l.type)return console.warn("Can't edit. Not a vector layer"),null;var m=l.map,n=l.map.svg,o=d3.geo.path().projection(l.map.projection).pointRadius(4.5),p=m.projection,q=[],r=null,s=null,t=function(a){s={id:(new Date).getTime().toString(),type:"Feature",geometry:{type:a,coordinates:[]},style:{opacity:.7},properties:{}},r=a,"Point"==r?m.svg.on("click",e):"LineString"==r?(s.style.fill="none",m.svg.on("click",d),m.svg.on("mousemove",h),m.svg.on("dblclick",f)):"Polygon"==r&&(s.style.fill="blue",m.svg.on("click",d),m.svg.on("mousemove",h),m.svg.on("dblclick",g),m.svg.on("touchstart",function(){pressTimer=window.setTimeout(function(){alert("long press!"),g()},500)}).on("touchend",function(){clearTimeout(pressTimer)}))},u=function(){l.drawboard.selectAll(".entity").select("path").on("click",j)},v=function(){},w=function(){var a=new CustomEvent("featureReady",{detail:s});m.mapdiv.dispatchEvent(a),x()},x=function(){n.selectAll(".sketch").remove(),s=null,m.svg.on("mousemove",null),m.svg.on("click",null),m.svg.on("click",null),m.svg.on("dblclick",null),m.svg.on("dblclick",null),m.svg.on("touchstart",null),m.svg.on("touchend",null)};return k.draw=t,k.startEdit=u,k.remove=v,k.cancel=x,k},d3.mappu.Layer=function(a,b){return d3_mappu_Layer(a,b)},d3_mappu_Layer=function(a,b){b=b||{};var c,d={},e=d3.mappu.util.createID(),f=a,g=1,h=!0;"boolean"==typeof b.visible&&(h=b.visible);var i=function(){},j=function(){},k=function(){},l=function(a){return c=a,d.drawboard=c.svg.append("g"),c.addLayer(d),d.draw(),d};return Object.defineProperty(d,"id",{get:function(){return e},set:function(){console.warn("setting ID not allowed for layer")}}),Object.defineProperty(d,"name",{get:function(){return f},set:function(a){f=a}}),Object.defineProperty(d,"map",{get:function(){return c},set:function(a){c=a}}),Object.defineProperty(d,"opacity",{get:function(){return g},set:function(a){g=a,d.refresh(0)}}),Object.defineProperty(d,"visible",{get:function(){return h},set:function(a){h=a,d.draw(!0),d.refresh(0)}}),d.refresh=i,d.moveUp=j,d.moveDown=k,d.addTo=l,d._onAdd=function(a){c=a,d.drawboard=c.svg.append("g"),d.draw()},d._onRemove=function(){},d},d3.mappu.VectorLayer=function(a,b){return d3_mappu_VectorLayer(a,b)},d3_mappu_VectorLayer=function(a,b){function c(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function d(a){var b=d3.select(this);if(a.style)for(var c in a.style)b.select("path").style(c,a.style[c]);a._selected?b.append("path").attr("d",_path).style("stroke","none").style("fill","red").classed("halo",!0):b.selectAll(".halo").remove()}function e(b){"Polygon"!=b.geometry.type||c(b.geometry.coordinates[0])||b.geometry.coordinates[0].reverse(),d3.select(this).append("path").attr("d",_path).classed(a,!0).style("stroke","blue"),d3.select(this).append("text")}b=b||{},d3_mappu_Layer.call(this,a,b);var f=d3_mappu_Layer(a,b);f.type="vector";var g=[],h=b.duration||0,i=b.events;Object.defineProperty(f,"data",{get:function(){return g},set:function(a){g=a,j(!1)}}),Object.defineProperty(f,"events",{get:function(){return i},set:function(a){i=a}});var j=function(a){_path=d3.geo.path().projection(f.map.projection).pointRadius(function(a){return a.style&&a.style.radius?a.style.radius:4.5});var b=f.drawboard;a&&b.selectAll(".entity").remove();var c=b.selectAll(".entity").data(g,function(a){return a.id}),j=c.enter().append("g").classed("entity",!0).attr("id",function(a){return"entity"+a.id});j.each(e),j.each(d),c.exit().remove(),i&&i.forEach(function(a){j.select("path").on(a.event,a.action)}),f.refresh(a?0:h)},k=function(a){var c=f.drawboard;if(c.style("opacity",this.opacity).style("display",this.visible?"block":"none"),f.visible){var e=c.selectAll(".entity");if(b.reproject)e.select("path").transition().duration(a).attr("d",_path),b.labelfield&&e.each(function(a){var c=_path.centroid(a),d=a.properties[b.labelfield];e.select("text").attr("x",c[0]).attr("y",c[1]).classed("vectorLabel",!0).text(d)}),e.each(d);else{var g=f.map.zoombehaviour;c.attr("transform","translate("+g.translate()+")scale("+g.scale()+")").style("stroke-width",1/g.scale())}}else c.selectAll(".entity").remove()},l=function(a){g.forEach(function(b){return b.id==a.id?(b=a,void f.draw()):void 0}),g.push(a),f.draw()};return f.refresh=k,f.draw=j,f.addFeature=l,f},d3_mappu_VectorLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.RasterLayer=function(a,b){return d3_mappu_RasterLayer(a,b)},d3_mappu_RasterLayer=function(a,b){d3_mappu_Layer.call(this,a,b);var c=d3_mappu_Layer(a,b);c.type="raster";var d=b.url,e=b.ogc_type||"tms",f=b.layers,g=0;Object.defineProperty(c,"url",{get:function(){return d},set:function(a){d=a,k()}}),Object.defineProperty(c,"layers",{get:function(){return f},set:function(a){f=a,k()}}),c.clear=function(){};var h=function(a){var b=2<<a[2]-1,c=40075016.68/b,d=-20037508.34+a[0]*c,e=20037508.34-(a[1]+1)*c,f=d+","+e+","+(d+c)+","+(e+c);return f},i=function(a){var b;if("tms"==e)b=d.replace("{s}",["a","b","c","d"][3*Math.random()|0]).replace("{z}",a[2]).replace("{x}",a[0]).replace("{y}",a[1]).replace("%7Bs%7D",["a","b","c","d"][3*Math.random()|0]).replace("%7Bz%7D",a[2]).replace("%7Bx%7D",a[0]).replace("%7By%7D",a[1]);else if("wms"==e){var c=h(a);b=d+"&bbox="+c+"&layers="+f+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:3857&transparent=TRUE&format=image%2Fpng"}return b},j=function(a){return},k=function(){var a=c.drawboard,b=c.map.tiles;a.transition().duration(g).attr("transform","scale("+b.scale+")translate("+b.translate+")");var d=a.selectAll(".tile").data(b,function(a){return a}),e=d.enter();c.visible&&e.append("image").classed("tile",!0).attr("xlink:href",i).attr("width",1).attr("height",1).attr("opacity",this.opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}).on("click",j),d.exit().remove()},l=function(){k(),c.drawboard.style("opacity",this.opacity).style("display",this.visible?"block":"none")};return c.refresh=l,c.draw=k,c},d3_mappu_RasterLayer.prototype=Object.create(d3_mappu_Layer.prototype),d3.mappu.Controllers=function(a){return d3_mappu_Controllers(a)},d3_mappu_Controllers=function(a){var b=d3.behavior.drag().on("drag",function(){console.log("Drag",d3.mouse(this))}).on("dragend",function(){console.log("Dragend",d3.mouse(this))});a.svg.call(b)},d3.mappu.Coordinates=function(a){return d3_mappu_Coordinates(a)},d3_mappu_Coordinates=function(){var a={};return a.addTo=function(a){var b=d3.select(a.mapdiv).append("div").classed("coordinates",!0);a.svg.on("mousemove",function(){var c=d3.mouse(this),d=a.projection.invert(c);b.html("lat: "+Math.round(100*d[0])/100+"| lon: "+Math.round(100*d[1])/100)})},a};